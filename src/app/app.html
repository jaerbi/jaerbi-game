<div class="min-h-screen bg-gray-900 text-white flex flex-col items-center justify-start p-4 relative overflow-hidden">
  <!-- Floating Giants Background -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none select-none z-0">
    <div class="floating-shape shape-giant-1"></div>
    <div class="floating-shape shape-giant-2"></div>
    <div class="floating-shape shape-giant-3"></div>
    <div class="floating-shape shape-giant-4"></div>
    <div class="floating-shape shape-giant-5"></div>
  </div>

  <!-- SVG Defs for Soft Shapes -->
  <svg width="0" height="0" class="absolute pointer-events-none">
    <defs>
      <clipPath id="soft-triangle" clipPathUnits="objectBoundingBox">
        <path
          d="M0.5 0.05 Q0.5 0 0.56 0.12 L0.92 0.85 Q0.98 0.98 0.85 0.98 L0.15 0.98 Q0.02 0.98 0.08 0.85 L0.44 0.12 Q0.5 0 0.5 0.05"
        />
      </clipPath>
    </defs>
  </svg>
  <div class="flex gap-[0px] flex-col fixed top-4 left-4">
    <h1 class="text-3xl font-bold">Shape Tactics</h1>
    <h2 class="text-sm text-gray-400">Turn-Based Strategy</h2>
  </div>
  <div class="w-full max-w-4xl flex items-center justify-between mb-4">
    <div class="flex items-center justify-center gap-[4px]">
      <button
        (click)="gameEngine.resetGame()"
        class="flex items-center gap-1 px-3 py-2 rounded-full hover:bg-gray-700 text-sm cursor-pointer"
      >
        <span class="text-base">Reload</span>
        <span class="text-base">üîÑ</span>
      </button>
      <button
        class="flex items-center gap-1 px-3 py-2 rounded-full hover:bg-gray-700 text-sm cursor-pointer"
        (click)="gameEngine.toggleRules()"
      >
        <span class="text-base">Rules</span>
        <span class="text-base">‚ùî</span>
      </button>
      <button
        class="flex items-center gap-1 px-3 py-2 rounded-full hover:bg-gray-700 text-sm cursor-pointer"
        (click)="gameEngine.toggleHighScores()"
      >
        <span class="text-base">High Score</span>
        <span class="text-base">üèÜ</span>
      </button>
      <button
        class="flex items-center gap-1 px-3 py-2 rounded-full hover:bg-gray-700 text-sm cursor-pointer"
        (click)="gameEngine.toggleLeaderboard()"
      >
        <span class="text-base">Leaderboard</span>
        <span class="text-base">üëë</span>
      </button>
      <button
        class="flex items-center gap-1 px-2 py-2 rounded-full hover:bg-gray-700 text-sm cursor-pointer"
        (click)="gameEngine.toggleLog()"
      >
        <span class="text-base">Log</span>
        <span class="text-base">‚ùó</span>
      </button>
    </div>

    <div class="flex items-center justify-center gap-[0px]">
      <button
        class="flex items-center gap-1 px-2 py-2 rounded-full hover:bg-gray-700 text-sm cursor-pointer"
        (click)="gameEngine.toggleSettings()"
      >
        <span class="w-5 h-5 flex items-center justify-center rounded-full text-white text-lg">‚öôÔ∏è</span>
      </button>
      <!-- Auth Section -->
      @if (firebase.user$(); as user) {
        <div class="flex items-center gap-2 ml-2 pl-4 border-l border-gray-700">
          @if (user.photoURL) {
            <img
              [src]="user.photoURL"
              class="w-8 h-8 rounded-full border border-gray-500"
              referrerpolicy="no-referrer"
              [title]="user.displayName"
            />
          } @else {
            <div
              class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-xs font-bold border border-gray-400"
              [title]="user.displayName"
            >
              {{ user.displayName?.charAt(0) ?? 'U' }}
            </div>
          }
          <button (click)="firebase.logout()" class="text-xs text-gray-400 hover:text-white underline cursor-pointer">
            Logout
          </button>
        </div>
      } @else {
        <button
          (click)="firebase.loginWithGoogle()"
          class="ml-2 flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 text-xs font-semibold transition-colors cursor-pointer"
        >
          <span class="text-blue-400">G</span>
          <span>Login</span>
        </button>
      }
    </div>
  </div>
  <div
    class="w-full max-w-4xl flex items-center justify-between mb-5 px-3 py-2 rounded-xl bg-white/5 backdrop-blur border border-gray-600/30"
  >
    <div class="flex items-center gap-4 text-xs">
      <span class="text-blue-300 font-semibold text-base">Player</span>
      <span class="flex items-center gap-1">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="7" y="14" width="13" height="6" rx="3" fill="#8B5E3C" />
          <circle cx="7" cy="17" r="3" fill="#A67B5B" stroke="#724A2D" stroke-width="1" />
          <circle cx="7" cy="17" r="1.5" stroke="#724A2D" stroke-width="0.5" />

          <rect x="7" y="5" width="13" height="6" rx="3" fill="#A67B5B" />
          <circle cx="7" cy="8" r="3" fill="#C49A6C" stroke="#8B5E3C" stroke-width="1" />
          <circle cx="7" cy="8" r="1.5" stroke="#8B5E3C" stroke-width="0.5" />
        </svg>
        <span>:</span>
        <span class="font-mono text-green-400 mt-[4px]">{{ gameEngine.resources().wood }}</span>
      </span>
      <span class="flex items-center gap-1">
        <!-- <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="0" y="0" width="24" height="24" fill="" />

          <circle cx="6" cy="10" r="5" fill="#388E3C" />
          <circle cx="14" cy="8" r="6" fill="#4CAF50" />
          <circle cx="20" cy="12" r="4" fill="#388E3C" />
          <circle cx="10" cy="16" r="5" fill="#4CAF50" />

          <rect x="4" y="14" width="2" height="10" fill="#8B5E3C" />
          <rect x="12" y="12" width="2" height="12" fill="#8B5E3C" />
          <rect x="18" y="16" width="2" height="8" fill="#8B5E3C" />
        </svg> -->
        <div class="w-6 h-6 flex-shrink-0">
          <svg viewBox="0 0 64 64" class="w-full h-full" xmlns="http://www.w3.org/2000/svg">
            <!-- Back tree (left) -->
            <polygon
              points="14,18 6,32 10,32 2,48 22,48 14,32 18,32"
              fill="#3f8f5c"
              stroke="#2e6b4c"
              stroke-width="2"
              stroke-linejoin="round"
              opacity="0.7"
            />
            <rect x="11" y="48" width="4.5" height="6" fill="#4f9f68" stroke="#2e6b4c" stroke-width="1.2" />

            <!-- Main tree (center) -->
            <polygon
              points="34,10 20,28 26,28 14,50 46,50 34,28 40,28"
              fill="#6fbf73"
              stroke="#2e6b4c"
              stroke-width="2"
              stroke-linejoin="round"
              opacity="0.85"
            />
            <rect x="31" y="50" width="6" height="6" fill="#4f9f68" stroke="#2e6b4c" stroke-width="1.5" />

            <!-- Right tree -->
            <polygon
              points="48,16 36,32 42,32 32,50 60,50 50,32 56,32"
              fill="#5fae7a"
              stroke="#2e6b4c"
              stroke-width="2"
              stroke-linejoin="round"
              opacity="0.75"
            />
            <rect x="45" y="50" width="5" height="6" fill="#4f9f68" stroke="#2e6b4c" stroke-width="1.2" />

            <!-- FLAG (team color) -->
            <g transform="translate(-14,-1) scale(1.4)">
              <rect x="28.5" y="18" width="3" height="20" fill="#71411e" />
              <polygon points="31,18 54,22 31,26" fill="#24aefe" />
            </g>
            <!-- wOOD -->
            <g transform="translate(10,52) scale(0.3)">
              <rect x="0" y="0" width="68" height="14" rx="7" fill="#d89b5a" stroke="#5a3418" stroke-width="2" />
              <circle cx="10" cy="7" r="3" fill="#5a3418" />
              <circle cx="58" cy="7" r="3" fill="#5a3418" />
            </g>
          </svg>
        </div>
        <span>:</span>
        <span class="font-mono text-blue-300 mt-[4px]">
          {{ gameEngine.getForestControl().player }}/{{ gameEngine.getForestControl().total }}
        </span>
      </span>
    </div>
    <div class="text-sm inline-flex gap-[8px]">
      <span class="text-gray-300">Turn:</span>
      <span class="font-bold text-yellow-400">{{ gameEngine.turn() }}</span>
      @if (gameEngine.monopolyTurnsLeft() > 0) {
        <span
          class="ml-2 px-2 py-0.5 rounded bg-emerald-800/40 border border-emerald-600/50 text-emerald-300"
          [class.victory-pulse]="gameEngine.monopolyTurnsLeft() <= 3"
        >
          Forest Victory in: {{ gameEngine.monopolyTurnsLeft() }} turns
        </span>
      }
      @if (gameEngine.gameStatus() !== 'playing') {
        <span class="ml-2 text-xs font-bold text-red-400">{{ gameEngine.gameStatus() | titlecase }}</span>
      }
    </div>
    <div class="flex items-center gap-4 text-xs">
      <span class="text-red-300 font-semibold text-base">jaerbi</span>
      <span class="flex inline-flex items-center gap-1">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="7" y="14" width="13" height="6" rx="3" fill="#8B5E3C" />
          <circle cx="7" cy="17" r="3" fill="#A67B5B" stroke="#724A2D" stroke-width="1" />
          <circle cx="7" cy="17" r="1.5" stroke="#724A2D" stroke-width="0.5" />

          <rect x="7" y="5" width="13" height="6" rx="3" fill="#A67B5B" />
          <circle cx="7" cy="8" r="3" fill="#C49A6C" stroke="#8B5E3C" stroke-width="1" />
          <circle cx="7" cy="8" r="1.5" stroke="#8B5E3C" stroke-width="0.5" />
        </svg>
        <span>:</span>
        <span class="font-mono text-red-400 mt-[4px]">{{ gameEngine.aiWood() }}</span>
      </span>
      <span class="flex items-center gap-1">
        <div class="w-6 h-6 flex-shrink-0">
          <svg viewBox="0 0 64 64" class="w-full h-full" xmlns="http://www.w3.org/2000/svg">
            <!-- Back tree (left) -->
            <polygon
              points="14,18 6,32 10,32 2,48 22,48 14,32 18,32"
              fill="#3f8f5c"
              stroke="#2e6b4c"
              stroke-width="2"
              stroke-linejoin="round"
              opacity="0.7"
            />
            <rect x="11" y="48" width="4.5" height="6" fill="#4f9f68" stroke="#2e6b4c" stroke-width="1.2" />

            <!-- Main tree (center) -->
            <polygon
              points="34,10 20,28 26,28 14,50 46,50 34,28 40,28"
              fill="#6fbf73"
              stroke="#2e6b4c"
              stroke-width="2"
              stroke-linejoin="round"
              opacity="0.85"
            />
            <rect x="31" y="50" width="6" height="6" fill="#4f9f68" stroke="#2e6b4c" stroke-width="1.5" />

            <!-- Right tree -->
            <polygon
              points="48,16 36,32 42,32 32,50 60,50 50,32 56,32"
              fill="#5fae7a"
              stroke="#2e6b4c"
              stroke-width="2"
              stroke-linejoin="round"
              opacity="0.75"
            />
            <rect x="45" y="50" width="5" height="6" fill="#4f9f68" stroke="#2e6b4c" stroke-width="1.2" />

            <!-- FLAG (team color) -->
            <g transform="translate(-14,-1) scale(1.4)">
              <rect x="28.5" y="18" width="3" height="20" fill="#71411e" />
              <polygon points="31,18 54,22 31,26" fill="#ef4444" />
            </g>
            <!-- wOOD -->
            <g transform="translate(10,52) scale(0.3)">
              <rect x="0" y="0" width="68" height="14" rx="7" fill="#d89b5a" stroke="#5a3418" stroke-width="2" />
              <circle cx="10" cy="7" r="3" fill="#5a3418" />
              <circle cx="58" cy="7" r="3" fill="#5a3418" />
            </g>
          </svg>
        </div>
        <span>:</span>
        <span class="font-mono text-red-300 mt-[4px]">
          {{ gameEngine.getForestControl().ai }}/{{ gameEngine.getForestControl().total }}
        </span>
      </span>
    </div>
  </div>

  @if (gameEngine.shouldShowEndOverlay()) {
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-600 text-center">
        <h2
          class="text-4xl font-bold mb-4"
          [class.text-blue-400]="gameEngine.gameStatus() === 'player wins'"
          [class.text-red-500]="gameEngine.gameStatus() === 'jaerbi wins'"
        >
          {{ gameEngine.gameStatus() | titlecase }}!
        </h2>
        @if (gameEngine.endReason()) {
          <div class="text-sm text-gray-300 mb-4">{{ gameEngine.endReason() }}</div>
        }
        @if (gameEngine.gameStatus() === 'player wins' && gameEngine.isNamePromptOpen()) {
          <div class="mb-4 flex flex-col items-center gap-2">
            <div class="text-sm text-gray-300">Confirm Player Name</div>
            <input
              #nameInput
              [value]="gameEngine.getPlayerName()"
              class="w-64 px-3 py-2 rounded bg-gray-700 border border-gray-600 text-white"
              placeholder="Enter your name"
              autocomplete="off"
            />
            <button
              (click)="gameEngine.confirmAndSaveScore(nameInput.value)"
              class="px-4 py-2 bg-yellow-600 hover:bg-yellow-500 rounded text-white font-semibold text-sm cursor-pointer"
            >
              Save Score
            </button>
          </div>
        }
        <button
          (click)="gameEngine.resetGame()"
          class="px-6 py-3 bg-green-600 hover:bg-green-500 rounded text-white font-bold text-lg cursor-pointer"
        >
          Play Again
        </button>
      </div>
      <button
        (click)="gameEngine.toggleLeaderboard()"
        class="ml-3 px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded text-white font-bold text-lg cursor-pointer"
      >
        View Leaderboard
      </button>
    </div>
  }
  <button
    class="fixed bottom-4 right-4 z-50 px-4 py-2 rounded-full bg-pink-600 hover:bg-pink-500 text-white shadow-xl cursor-pointer flex items-center gap-2 support-pulse"
    (click)="gameEngine.toggleSupport()"
    aria-label="Support the Project"
  >
    <span class="text-lg">‚ù§Ô∏è</span>
    <span class="text-lg mb-[2px]">Support</span>
  </button>
  @if (gameEngine.supportOpen()) {
    <app-support-community />
  }
  @if (gameEngine.leaderboardOpen()) {
    <app-leaderboard-modal />
  }

  <style>
    * {
      box-sizing: border-box;
    }
    .tile {
      min-width: 64px;
      min-height: 64px;
      aspect-ratio: 1 / 1;
      position: relative;
    }
    .combat-text-anim {
      animation: combatFloat 0.5s ease-out;
    }
    @keyframes combatFloat {
      from {
        transform: translateY(0);
      }
      to {
        transform: translateY(-12px);
      }
    }
    .shake {
      animation: defenderShake 200ms ease-out;
    }
    @keyframes defenderShake {
      0% {
        transform: translate(0, 0);
      }
      25% {
        transform: translate(2px, -2px);
      }
      50% {
        transform: translate(-2px, 2px);
      }
      75% {
        transform: translate(2px, 2px);
      }
      100% {
        transform: translate(0, 0);
      }
    }
    .arrival-pop {
      animation: arrivalPop 200ms ease-out;
    }
    @keyframes arrivalPop {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
      100% {
        transform: scale(1);
      }
    }
    .pulse-glow {
      animation: pulseGlow 400ms ease-out;
    }
    @keyframes pulseGlow {
      0% {
        box-shadow: 0 0 0px rgba(255, 215, 0, 0);
      }
      50% {
        box-shadow: 0 0 12px rgba(255, 215, 0, 0.8);
      }
      100% {
        box-shadow: 0 0 0px rgba(255, 215, 0, 0);
      }
    }
    .wood-pulse-icon {
      animation: woodPulse 1000ms ease-in-out infinite;
      filter: drop-shadow(0 0 4px rgba(16, 185, 129, 0.7));
    }
    @keyframes woodPulse {
      0% {
        transform: scale(0.9);
        opacity: 0.6;
      }
      50% {
        transform: scale(1.1);
        opacity: 1;
      }
      100% {
        transform: scale(0.9);
        opacity: 0.6;
      }
    }
  </style>
  <div class="relative z-10">
    <div
      #boardContainer
      [class.shake]="gameEngine.screenShake()"
      [class.mood-none]="gameEngine.currentMood() === 'none'"
      [class.mood-angry]="gameEngine.currentMood() === 'angry'"
      [class.mood-rage]="gameEngine.currentMood() === 'rage'"
      class="max-w-[90vw] max-h-[90vh] overflow-auto bg-gray-800 p-2 rounded-lg border border-gray-700 select-none relative mx-auto my-auto"
    >
      <div
        class="grid"
        [style.gridTemplateColumns]="
          'repeat(' +
          gameEngine.gridSize +
          ', minmax(' +
          gameEngine.tileMinSizePx +
          'px, ' +
          gameEngine.tileSizePx +
          'px))'
        "
        [style.gap.px]="gameEngine.wallThicknessPx"
      >
        <!-- Base Indicators -->
        <div
          class="absolute top-2 left-2 w-12 h-12 border-2 border-blue-500/30 rounded pointer-events-none flex items-center justify-center"
        >
          <span class="text-white font-bold bg-blue-600 px-1 rounded shadow text-xs">
            {{ gameEngine.baseHealth().player }}
          </span>
        </div>
        @if (gameEngine.isVisibleToPlayer(gameEngine.gridSize - 1, gameEngine.gridSize - 1)) {
          <div
            class="absolute bottom-2 right-2 w-12 h-12 border-2 border-red-500/30 rounded pointer-events-none flex items-center justify-center"
          >
            <span class="text-white font-bold bg-red-600 px-1 rounded shadow text-xs">
              {{ gameEngine.baseHealth().ai }}
            </span>
          </div>
        }

        @for (y of gameEngine.gridRows; track y) {
          @for (x of gameEngine.gridCols; track x) {
            <div
              (click)="onTileClick(x, y)"
              class="tile rounded flex items-center justify-center border transition-colors duration-200"
              [style.width.px]="gameEngine.tileSizePx"
              [style.height.px]="gameEngine.tileSizePx"
              [style.minWidth.px]="gameEngine.tileMinSizePx"
              [style.minHeight.px]="gameEngine.tileMinSizePx"
              [class.cursor-pointer]="gameEngine.isValidMove(x, y)"
              [attr.title]="
                gameEngine.getUnitAt(x, y) &&
                (gameEngine.getUnitAt(x, y)!.owner === 'player' || gameEngine.isVisibleToPlayer(x, y))
                  ? gameEngine.formatHoverInfo(gameEngine.getUnitAt(x, y)!.id)
                  : null
              "
              [class.bg-gray-700]="!gameEngine.isValidMove(x, y)"
              [class.border-gray-600]="!gameEngine.isValidMove(x, y)"
              [class.bg-blue-900]="x === 0 && y === 0"
              [class.bg-red-900]="x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1"
              [class.border-4]="
                (x === 0 && y === 0) || (x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1)
              "
              [class.border-blue-400]="x === 0 && y === 0"
              [class.border-red-400]="x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1"
              [class.ring-2]="(x === 0 && y === 0) || (x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1)"
              [class.ring-blue-300]="x === 0 && y === 0 && gameEngine.baseDeployActive()"
              [class.ring-red-300]="x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1"
              [class.spawn-zone-highlight]="gameEngine.baseDeployActive() && x <= 2 && y <= 2 && (x !== 0 || y !== 0)"
              [class.forest-area]="gameEngine.isForest(x, y)"
              [class.bg-amber-900]="gameEngine.isDeployTarget(x, y) && !gameEngine.buildMode()"
              [class.border-amber-500]="gameEngine.isDeployTarget(x, y) && !gameEngine.buildMode()"
              [class.bg-gray-950]="!gameEngine.isVisibleToPlayer(x, y)"
              [class.border-gray-800]="!gameEngine.isVisibleToPlayer(x, y)"
              [class.bg-green-900]="gameEngine.isValidMove(x, y) && !gameEngine.getUnitAt(x, y)"
              [class.border-green-500]="gameEngine.isValidMove(x, y) && !gameEngine.getUnitAt(x, y)"
              [class.bg-cyan-900]="gameEngine.isValidMove(x, y) && gameEngine.getUnitAt(x, y)"
              [class.border-cyan-500]="gameEngine.isValidMove(x, y) && gameEngine.getUnitAt(x, y)"
              [class.animate-pulse]="gameEngine.isValidMove(x, y) && gameEngine.getUnitAt(x, y)"
              [class.hover:bg-gray-600]="!gameEngine.isValidMove(x, y)"
              [class.hover:bg-green-800]="gameEngine.isValidMove(x, y) && !gameEngine.getUnitAt(x, y)"
              [class.hover:bg-cyan-800]="gameEngine.isValidMove(x, y) && gameEngine.getUnitAt(x, y)"
            >
              <!-- Grid coordinate helper -->
              <span class="absolute top-0 right-0 text-[8px] text-gray-500 p-0.5 pointer-events-none">
                {{ x }},{{ y }}
              </span>
              @if (
                x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1 && gameEngine.isVisibleToPlayer(x, y)
              ) {
                @if (gameEngine.isRage()) {
                  <span
                    class="absolute -top-2 -right-2 text-xl [filter:drop-shadow(0_0_2px_rgba(0,0,0,0.5))]"
                    [style.z-index]="100"
                  >
                    ü§¨
                  </span>
                } @else if (gameEngine.isAngry()) {
                  <span
                    class="absolute -top-2 -right-2 text-xl [filter:drop-shadow(0_0_2px_rgba(0,0,0,0.5))]"
                    [style.z-index]="100"
                  >
                    üò†
                  </span>
                }
              }
              @if (gameEngine.buildMode() && gameEngine.isInSafeZone(x, y)) {
                <div
                  class="absolute inset-0 bg-red-800/20 border-2 border-red-500/40 border-dashed pointer-events-none"
                ></div>
              }
              @if (gameEngine.isForest(x, y) && gameEngine.isVisibleToPlayer(x, y)) {
                <span class="absolute pointer-events-none">
                  <svg viewBox="0 0 128 128" class="w-full h-full" xmlns="http://www.w3.org/2000/svg">
                    <!-- Gradients -->
                    <defs>
                      <linearGradient id="bg" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="#2f5d46" />
                        <stop offset="100%" stop-color="#1f3b2d" />
                      </linearGradient>

                      <linearGradient id="tree" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="#9be7b3" />
                        <stop offset="100%" stop-color="#4f9f68" />
                      </linearGradient>

                      <linearGradient id="wood" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="#d89b5a" />
                        <stop offset="100%" stop-color="#8b5a2b" />
                      </linearGradient>

                      <linearGradient id="metal" x1="0" y1="0" x2="1" y2="1">
                        <stop offset="0%" stop-color="#e6e6e6" />
                        <stop offset="100%" stop-color="#9aa3a8" />
                      </linearGradient>
                    </defs>

                    <!-- Background tile -->
                    <rect width="128" height="128" rx="14" fill="url(#bg)" />

                    <!-- Back trees -->
                    <g opacity="0.6">
                      <polygon points="28,60 12,90 22,90 8,112 48,112 34,90 44,90" fill="#3f7f5c" />
                      <polygon points="100,58 84,90 94,90 80,112 120,112 106,90 116,90" fill="#3f7f5c" />
                    </g>

                    <!-- Main tree -->
                    <polygon
                      points="64,22 36,66 50,66 28,98 100,98 78,66 92,66"
                      fill="url(#tree)"
                      stroke="#2e6b4c"
                      stroke-width="3"
                      stroke-linejoin="round"
                    />
                    <rect x="58" y="98" width="12" height="16" fill="#4f9f68" stroke="#2e6b4c" stroke-width="2" />

                    <!-- Wood log -->
                    <g transform="translate(10,110)">
                      <rect
                        x="0"
                        y="0"
                        width="68"
                        height="14"
                        rx="7"
                        fill="url(#wood)"
                        stroke="#5a3418"
                        stroke-width="2"
                      />
                      <circle cx="10" cy="7" r="3" fill="#5a3418" />
                      <circle cx="58" cy="7" r="3" fill="#5a3418" />
                    </g>

                    <g transform="translate(15, -45)">
                      <!-- Axe handle -->
                      <rect
                        x="78"
                        y="56"
                        width="6"
                        height="44"
                        rx="3"
                        fill="#7a4a21"
                        stroke="#4a2a12"
                        stroke-width="2"
                        transform="rotate(-25 78 56)"
                      />
                      <!-- Axe blade -->
                      <g transform="rotate(160 83 60)">
                        <path
                          d="M92 50 C105 48, 110 60, 98 68 L84 60 Z"
                          fill="url(#metal)"
                          stroke="#5f6b73"
                          stroke-width="2"
                        />
                      </g>
                    </g>
                  </svg>
                </span>
              }
              @if (gameEngine.isForest(x, y) && gameEngine.getUnitAt(x, y) && gameEngine.isVisibleToPlayer(x, y)) {
                <div
                  class="absolute top-0 left-0 right-0 bg-green-400/70 pointer-events-none"
                  [style.height.px]="2"
                ></div>
              }
              @if (x === 0 && y === 0) {
                <span
                  class="absolute inset-x-0 top-0 m-0.5 text-[10px] font-extrabold text-blue-900 bg-blue-300/80 rounded px-1 pointer-events-none"
                >
                  {{ gameEngine.baseHealth().player }}
                </span>
                <span
                  class="absolute left-0 bottom-0 m-0.5 text-[10px] font-extrabold text-white bg-blue-600/90 rounded px-1 pointer-events-none"
                >
                  {{ gameEngine.reservePoints().player }}
                </span>
              }
              @if (x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1) {
                @if (gameEngine.isVisibleToPlayer(x, y)) {
                  <span
                    class="absolute inset-x-0 top-0 m-0.5 text-[10px] font-extrabold text-red-900 bg-red-300/80 rounded px-1 pointer-events-none"
                  >
                    {{ gameEngine.baseHealth().ai }}
                  </span>
                  <span
                    class="absolute right-0 bottom-0 m-0.5 text-[10px] font-extrabold text-white bg-red-600/90 rounded px-1 pointer-events-none"
                  >
                    {{ gameEngine.reservePoints().ai }}
                  </span>
                }
              }

              @if (x < gameEngine.gridSize - 1) {
                @if (gameEngine.getWallBetween(x, y, x + 1, y); as vWall) {
                  @if (gameEngine.shouldRenderWall({ x: x, y: y }, { x: x + 1, y: y }, vWall.owner)) {
                    <div
                      class="absolute rounded-xs right-0 top-0 h-full flex items-center justify-center"
                      [style.right.px]="-gameEngine.wallThicknessPx"
                      [style.width.px]="gameEngine.wallThicknessPx"
                      [style.height.%]="vWall.health"
                      [style.z-index]="40"
                      [style.transition]="'height 0.25s ease-out'"
                      [class.bg-lime-400]="vWall.owner === 'player'"
                      [class.bg-red-400]="vWall.owner === 'ai'"
                      [class.bg-gray-300]="vWall.owner === 'neutral'"
                      [class.shake]="gameEngine.isWallShaking(vWall.id)"
                    >
                      @if (gameEngine.canShowAttackIcon({ x: x, y: y }, { x: x + 1, y: y })) {
                        <button
                          class="cursor-pointer shadow-lg flex items-center justify-center text-white"
                          [style.width.px]="gameEngine.iconSizePx"
                          [style.height.px]="gameEngine.iconSizePx"
                          [style.z-index]="45"
                          [class.bg-red-600]="vWall.owner === 'player'"
                          [class.bg-yellow-500]="vWall.owner === 'ai'"
                          [class.bg-gray-600]="vWall.owner === 'neutral'"
                          (click)="
                            vWall.owner === 'player'
                              ? onDestroyIconClick($event, x, y, x + 1, y)
                              : onAttackIconClick($event, x, y, x + 1, y)
                          "
                        >
                          {{ vWall.owner === 'player' ? '‚úñ' : '‚öî' }}
                        </button>
                      }
                    </div>
                  }
                } @else {
                  <div
                    class="absolute rounded-xs right-0 top-0 h-full flex items-center justify-center"
                    [style.right.px]="-gameEngine.wallThicknessPx"
                    [style.width.px]="gameEngine.wallThicknessPx"
                    [style.height.%]="100"
                    [style.z-index]="40"
                    [style.transition]="'height 0.25s ease-out'"
                    [class.bg-lime-700]="
                      gameEngine.buildMode() && gameEngine.canBuildWallBetween({ x: x, y: y }, { x: x + 1, y: y })
                    "
                    [class.bg-transparent]="
                      !gameEngine.buildMode() || !gameEngine.canBuildWallBetween({ x: x, y: y }, { x: x + 1, y: y })
                    "
                  >
                    @if (gameEngine.canShowBuildIcon({ x: x, y: y }, { x: x + 1, y: y })) {
                      <button
                        class="bg-green-500 cursor-pointer text-white rounded-full shadow-lg flex items-center justify-center"
                        [style.fontSize.px]="gameEngine.iconSizePx"
                        [style.width.px]="gameEngine.iconSizePx"
                        [style.height.px]="gameEngine.iconSizePx"
                        [style.z-index]="45"
                        (click)="onBuildIconClick($event, x, y, x + 1, y)"
                      >
                        ‚úî
                      </button>
                    }
                    @if (
                      (gameEngine.isVisibleToPlayer(x, y) || gameEngine.isVisibleToPlayer(x + 1, y)) &&
                      gameEngine.edgeCooldownRemaining({ x: x, y: y }, { x: x + 1, y: y }) > 0
                    ) {
                      <span class="absolute whitespace-nowrap right-0 top-0 text-[10px] text-yellow-300 px-1">
                        CD: {{ gameEngine.edgeCooldownRemaining({ x: x, y: y }, { x: x + 1, y: y }) }}
                      </span>
                    }
                  </div>
                }
              }

              @if (y < gameEngine.gridSize - 1) {
                @if (gameEngine.getWallBetween(x, y, x, y + 1); as hWall) {
                  @if (gameEngine.shouldRenderWall({ x: x, y: y }, { x: x, y: y + 1 }, hWall.owner)) {
                    <div
                      class="absolute rounded-xs left-0 bottom-0 w-full flex items-center justify-center"
                      [style.bottom.px]="-gameEngine.wallThicknessPx"
                      [style.height.px]="gameEngine.wallThicknessPx"
                      [style.width.%]="hWall.health"
                      [style.z-index]="40"
                      [style.transition]="'width 0.25s ease-out'"
                      [class.bg-lime-400]="hWall.owner === 'player'"
                      [class.bg-red-400]="hWall.owner === 'ai'"
                      [class.bg-gray-300]="hWall.owner === 'neutral'"
                      [class.shake]="gameEngine.isWallShaking(hWall.id)"
                    >
                      @if (gameEngine.canShowAttackIcon({ x: x, y: y }, { x: x, y: y + 1 })) {
                        <button
                          class="rounded-full cursor-pointer shadow-lg flex items-center justify-center text-white"
                          [style.width.px]="gameEngine.iconSizePx"
                          [style.height.px]="gameEngine.iconSizePx"
                          [style.z-index]="45"
                          [class.bg-red-600]="hWall.owner === 'player'"
                          [class.bg-yellow-500]="hWall.owner === 'ai'"
                          [class.bg-gray-600]="hWall.owner === 'neutral'"
                          (click)="
                            hWall.owner === 'player'
                              ? onDestroyIconClick($event, x, y, x, y + 1)
                              : onAttackIconClick($event, x, y, x, y + 1)
                          "
                        >
                          {{ hWall.owner === 'player' ? '‚úñ' : '‚öî' }}
                        </button>
                      }
                    </div>
                  }
                } @else {
                  <div
                    class="absolute rounded-xs left-0 bottom-0 w-full flex items-center justify-center"
                    [style.bottom.px]="-gameEngine.wallThicknessPx"
                    [style.height.px]="gameEngine.wallThicknessPx"
                    [style.width.%]="100"
                    [style.z-index]="40"
                    [style.transition]="'width 0.25s ease-out'"
                    [class.bg-lime-700]="
                      gameEngine.buildMode() && gameEngine.canBuildWallBetween({ x: x, y: y }, { x: x, y: y + 1 })
                    "
                    [class.bg-transparent]="
                      !gameEngine.buildMode() || !gameEngine.canBuildWallBetween({ x: x, y: y }, { x: x, y: y + 1 })
                    "
                  >
                    @if (gameEngine.canShowBuildIcon({ x: x, y: y }, { x: x, y: y + 1 })) {
                      <button
                        class="bg-green-500 cursor-pointer text-white rounded-full shadow-lg flex items-center justify-center"
                        [style.fontSize.px]="gameEngine.iconSizePx"
                        [style.width.px]="gameEngine.iconSizePx"
                        [style.height.px]="gameEngine.iconSizePx"
                        [style.z-index]="45"
                        (click)="onBuildIconClick($event, x, y, x, y + 1)"
                      >
                        ‚úî
                      </button>
                    }
                    @if (
                      (gameEngine.isVisibleToPlayer(x, y) || gameEngine.isVisibleToPlayer(x, y + 1)) &&
                      gameEngine.edgeCooldownRemaining({ x: x, y: y }, { x: x, y: y + 1 }) > 0
                    ) {
                      <span class="absolute whitespace-nowrap left-0 bottom-0 text-[10px] text-yellow-300 px-1">
                        CD: {{ gameEngine.edgeCooldownRemaining({ x: x, y: y }, { x: x, y: y + 1 }) }}
                      </span>
                    }
                  </div>
                }
              }

              @if (gameEngine.getUnitAt(x, y); as unit) {
                @if (unit.owner === 'player' || gameEngine.isVisibleToPlayer(x, y)) {
                  @if (!(x === 0 && y === 0) && !(x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1)) {
                    <div
                      class="pointer-events-none"
                      [style.transition]="'transform 150ms ease-out'"
                      [class.unit-container-player-unit-tier-2]="unit.owner === 'player' && unit.tier === 2"
                      [class.unit-container-ai-unit-tier-2]="unit.owner === 'ai' && unit.tier === 2"
                      [style.transform]="
                        gameEngine.getNudgeFor(unit.id)
                          ? 'translate(' +
                            gameEngine.getNudgeFor(unit.id)!.dx +
                            'px,' +
                            gameEngine.getNudgeFor(unit.id)!.dy +
                            'px)'
                          : 'translate(0,0)'
                      "
                      [class.shake]="gameEngine.isUnitShaking(unit.id)"
                    >
                      <!-- [style.clip-path]="unit.tier === 2 ? 'polygon(50% 0%, 0% 100%, 100% 100%)' : ''" -->
                      <!-- [style.padding-top]="unit.tier === 2 ? '0.25rem' : ''" -->
                      <!-- [class.border-blue-300]="unit.owner === 'player' && unit.tier !== 2" -->
                      <!-- [class.border-red-300]="unit.owner === 'ai' && unit.tier !== 2" -->
                      <div
                        class="flex items-center justify-center font-bold unit-base unit-base"
                        [style.width.px]="gameEngine.tileUnitSizePx"
                        [style.height.px]="gameEngine.tileUnitSizePx"
                        [style.aspectRatio]="'1 / 1'"
                        [attr.title]="gameEngine.formatHoverInfo(unit.id)"
                        [class.unit-player]="unit.owner === 'player'"
                        [class.unit-ai]="unit.owner === 'ai'"
                        [class.text-white]="true"
                        [class.unit-tier-1]="unit.tier === 1"
                        [class.unit-tier-2]="unit.tier === 2"
                        [class.unit-tier-3]="unit.tier === 3"
                        [class.unit-tier-4]="unit.tier === 4"
                        [class.scale-75]="unit.tier === 4"
                        [class.ring-4]="gameEngine.selectedUnitId() === unit.id"
                        [class.ring-yellow-400]="gameEngine.selectedUnitId() === unit.id"
                        [class.ring-offset-2]="gameEngine.selectedUnitId() === unit.id"
                        [class.ring-offset-gray-800]="gameEngine.selectedUnitId() === unit.id"
                        [class.scale-110]="
                          gameEngine.selectedUnitId() === unit.id && unit.tier !== 4 && !gameEngine.buildMode()
                        "
                        [class.scale-90]="
                          gameEngine.selectedUnitId() === unit.id && unit.tier === 4 && !gameEngine.buildMode()
                        "
                        [class.scale-125]="gameEngine.lastMergedUnitId() === unit.id"
                        [class.scale-50]="gameEngine.buildMode()"
                        [class.animate-bounce]="gameEngine.lastRemainderUnitId() === unit.id"
                        [class.arrival-pop]="gameEngine.lastArrivedUnitId() === unit.id"
                        [class.pulse-glow]="gameEngine.pulseUnitId() === unit.id"
                      >
                        <span [class.-rotate-45]="unit.tier === 4">{{ unit.level }}</span>
                      </div>
                      @if (gameEngine.hasDefenseBonus(unit)) {
                        <span
                          class="absolute -top-1 -right-1 rounded-full bg-blue-200 text-blue-900 flex items-center justify-center"
                          [style.width.px]="gameEngine.iconSizePx"
                          [style.height.px]="gameEngine.iconSizePx"
                          [style.fontSize.px]="gameEngine.iconSizePx - 2 > 8 ? gameEngine.iconSizePx - 2 : 8"
                          [style.z-index]="100"
                        >
                          üõ°
                        </span>
                      }
                      @if (unit.productionActive) {
                        <span
                          class="absolute -bottom-1 -right-1 [filter:drop-shadow(0_0_2px_rgba(0,0,0,0.5))]"
                          [style.z-index]="100"
                        >
                          üå≥
                        </span>
                      } @else if ((unit.forestOccupationTurns ?? 0) === 1) {
                        <span
                          class="absolute -bottom-1 -right-1 opacity-70 [filter:drop-shadow(0_0_2px_rgba(0,0,0,0.5))]"
                          [style.z-index]="100"
                        >
                          üå±
                        </span>
                      } @else if ((unit.forestOccupationTurns ?? 0) > 1) {
                        <span
                          class="absolute -bottom-1 -right-1 opacity-70 [filter:drop-shadow(0_0_2px_rgba(0,0,0,0.5))]"
                          [style.z-index]="100"
                        >
                          üåø
                        </span>
                      }
                    </div>
                  }
                }
              }

              @for (entry of gameEngine.getCombatTextEntriesAt(x, y); track entry.id) {
                <div
                  class="absolute inset-0 flex items-center justify-center pointer-events-none transition-opacity duration-500 combat-text-anim"
                  [style.z-index]="100"
                  [style.opacity]="entry.opacity"
                >
                  <span
                    [class.text-xs]="!gameEngine.isLuckyText(entry.text) && !gameEngine.isDrawText(entry.text)"
                    [class.text-base]="gameEngine.isLuckyText(entry.text) || gameEngine.isDrawText(entry.text)"
                    [class.text-yellow-300]="!gameEngine.isLuckyText(entry.text) && !gameEngine.isDrawText(entry.text)"
                    [class.text-yellow-400]="gameEngine.isLuckyText(entry.text) || gameEngine.isDrawText(entry.text)"
                    class="font-extrabold"
                  >
                    {{ entry.text }}
                  </span>
                </div>
              }
            </div>
          }
        }
      </div>
    </div>

    <!-- Difficulty -->
    <div class="mt-4 flex min-w-40 flex-col gap-[0] absolute top-0 right-[-186px]">
      <span class="text-stone-300 font-bold text-2lg">Difficulty:</span>
      <span
        class="font-semibold text-lg capitalize"
        [class.text-lime-300]="'baby' === settings.difficulty()"
        [class.text-emerald-300]="'normal' === settings.difficulty()"
        [class.text-orange-500]="'hard' === settings.difficulty()"
        [class.text-red-500]="'nightmare' === settings.difficulty()"
      >
        {{ settings.difficulty() }}
        <span>
          {{
            'baby' === settings.difficulty()
              ? 'üë∂'
              : 'normal' === settings.difficulty()
                ? 'ü§†'
                : 'hard' === settings.difficulty()
                  ? 'üòà'
                  : '‚ò†Ô∏è'
          }}
        </span>
      </span>
    </div>
    <!-- Difficulty END -->
    <!-- Actions -->
    <div
      class="mt-4 flex flex-col items-start gap-2 absolute top-0 left-[-208px] p-4 rounded-2xl bg-gray-900/40 backdrop-blur-md border border-white/10 shadow-2xl"
    >
      <div class="flex gap-2 flex-col w-full">
        <button
          (click)="gameEngine.toggleBuildMode()"
          class="cursor-pointer group relative px-4 py-3 rounded-xl text-sm font-bold transition-all duration-200 flex items-center justify-between gap-3 overflow-hidden border border-blue-400/30 bg-gradient-to-br from-blue-600/20 to-blue-800/40 hover:from-blue-500/40 hover:to-blue-700/60 shadow-[0_0_15px_rgba(59,130,246,0.2)] active:scale-95 disabled:opacity-40 disabled:grayscale disabled:cursor-not-allowed"
          [class.ring-2]="gameEngine.buildMode()"
          [class.ring-blue-400]="gameEngine.buildMode()"
          [disabled]="gameEngine.wallBuiltThisTurn() || !gameEngine.canBuildThisTurn()"
        >
          <div class="flex items-center gap-0 z-10">
            <span class="text-blue-200">+1</span>
            <div class="scale-95 origin-center">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M4 20V8L6 5L8 8V20" fill="#8B5E3C" stroke="#5D4037" stroke-width="1" />
                <path d="M9 20V6L11 3L13 6V20" fill="#A67B5B" stroke="#5D4037" stroke-width="1" />
                <path d="M14 20V8L16 5L18 8V20" fill="#8B5E3C" stroke="#5D4037" stroke-width="1" />
                <rect x="3" y="12" width="18" height="2" fill="#5D4037" />
              </svg>
            </div>
          </div>
          <div class="flex flex-center bg-black/40 px-2 py-1 rounded-lg border border-white/10 z-10 text-red-300">
            <span>-10</span>
            <div class="w-6 h-6 flex-shrink-0 rotate-90">
              <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                <rect x="8" y="26" width="48" height="14" rx="7" fill="#c68642" stroke="#8b5a2b" stroke-width="3" />

                <circle cx="14" cy="33" r="3" fill="#8b5a2b" />
                <circle cx="50" cy="33" r="3" fill="#8b5a2b" />
              </svg>
            </div>
          </div>
          <div
            class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite] pointer-events-none"
          ></div>
        </button>

        <button
          (click)="gameEngine.convertWoodToReserve()"
          [disabled]="!gameEngine.canAddReserveTurn()"
          class="cursor-pointer group relative px-4 py-3 rounded-xl text-sm font-bold transition-all duration-200 border border-emerald-400/30 bg-gradient-to-br from-emerald-600/20 to-emerald-800/40 hover:from-emerald-500/40 hover:to-emerald-700/60 shadow-[0_0_15px_rgba(16,185,129,0.1)] active:scale-95 disabled:opacity-40 disabled:grayscale disabled:cursor-not-allowed"
        >
          <div class="flex items-center justify-between w-full gap-0 z-10">
            <span class="flex flex-center text-emerald-200">
              <span>20</span>
              <div class="w-6 h-6 flex-shrink-0 rotate-90">
                <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                  <rect x="8" y="26" width="48" height="14" rx="7" fill="#c68642" stroke="#8b5a2b" stroke-width="3" />

                  <circle cx="14" cy="33" r="3" fill="#8b5a2b" />
                  <circle cx="50" cy="33" r="3" fill="#8b5a2b" />
                </svg>
              </div>
            </span>
            <span class="text-lg">‚ûî</span>
            <span class="text-emerald-200 text-lg">1 üë§</span>
          </div>
        </button>

        <button
          (click)="gameEngine.maxConvertWoodToReserve()"
          [disabled]="!gameEngine.canAddReserveTurn()"
          class="cursor-pointer group relative px-4 py-3 rounded-xl text-sm font-bold transition-all duration-200 border border-amber-400/30 bg-gradient-to-br from-amber-600/20 to-amber-800/40 hover:from-amber-500/40 hover:to-amber-700/60 shadow-[0_0_15px_rgba(245,158,11,0.1)] active:scale-95 disabled:opacity-40 disabled:grayscale disabled:cursor-not-allowed"
        >
          <div class="flex items-center justify-between w-full gap-0 z-10 text-amber-200">
            <span class="text-xs uppercase tracking-tighter">ALL</span>
            <span class="text-lg">‚ûî</span>
            <span class="text-lg">üë•++</span>
          </div>
        </button>
      </div>

      <label
        class="mt-2 flex items-center gap-3 w-full px-2 py-2 rounded-lg hover:bg-white/5 transition-colors cursor-pointer border border-transparent hover:border-white/5"
      >
        <div class="relative flex items-center">
          <input
            type="checkbox"
            class="peer h-4 w-4 opacity-0 absolute"
            [checked]="gameEngine.fogDebugDisabled()"
            (change)="gameEngine.toggleFogDebug()"
          />
          <div
            class="h-4 w-4 border-2 border-gray-500 rounded flex items-center justify-center peer-checked:bg-blue-500 peer-checked:border-blue-500 transition-all"
          >
            <div class="h-2 w-2 bg-white rounded-full opacity-0 peer-checked:opacity-100"></div>
          </div>
        </div>
        <span class="text-[10px] uppercase tracking-widest text-gray-400 font-bold">Map Hack</span>
      </label>
    </div>
    <!-- Actions END -->
  </div>

  <!-- <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
    <input
      type="checkbox"
      class="h-4 w-4 rounded border-gray-500 bg-gray-800 cursor-pointer"
      [checked]="gameEngine.autoDeployEnabled()"
      (change)="gameEngine.toggleAutoDeploy()"
    />
    <span>Auto-Deploy</span>
  </label> -->

  <!-- -------------------------------------------- Version -------------------------------------------- -->
  <div class="fixed bottom-4 left-4 text-[12px] text-gray-500">version: 0.3.3 | ¬©Ô∏é Created by jaerbi and just</div>

  @if (gameEngine.rulesOpen()) {
    <app-game-rules />
  }
  @if (gameEngine.logOpen()) {
    <div class="fixed inset-y-0 right-0 w-80 bg-gray-900/90 border-l border-gray-700 p-4 z-40">
      <h3 class="text-lg font-bold mb-2">Action Log</h3>
      <label class="flex items-center gap-2 text-xs text-gray-300 mb-2 cursor-pointer">
        <input
          type="checkbox"
          class="h-4 w-4 rounded border-gray-500 bg-gray-800 cursor-pointer"
          [checked]="gameEngine.combatOnly()"
          (change)="gameEngine.toggleCombatOnly()"
        />
        <span>Combat Only</span>
      </label>
      <div class="h-[78vh] overflow-y-auto space-y-2 text-xs">
        @for (entry of gameEngine.logsFiltered(); track entry.text) {
          <div [class]="entry.color">{{ entry.text }}</div>
        }
      </div>
    </div>
  }
  @if (gameEngine.settingsOpen()) {
    <div class="fixed inset-y-0 left-0 w-64 bg-gray-900/90 border-r border-gray-700 p-4 z-40">
      <h3 class="text-lg font-bold mb-2">Settings</h3>
      <div class="mb-3">
        <label class="text-sm mb-1 block">Difficulty</label>
        <div class="flex flex-wrap gap-2">
          <button
            class="px-3 py-1 rounded text-sm cursor-pointer"
            [class.bg-blue-600]="settings.difficulty() === 'baby'"
            [class.bg-gray-700]="settings.difficulty() !== 'baby'"
            (click)="onDifficultyChange('baby')"
          >
            Baby
          </button>
          <button
            class="px-3 py-1 rounded text-sm cursor-pointer"
            [class.bg-blue-600]="settings.difficulty() === 'normal'"
            [class.bg-gray-700]="settings.difficulty() !== 'normal'"
            (click)="onDifficultyChange('normal')"
          >
            Normal
          </button>
          <button
            class="px-3 py-1 rounded text-sm cursor-pointer"
            [class.bg-blue-600]="settings.difficulty() === 'hard'"
            [class.bg-gray-700]="settings.difficulty() !== 'hard'"
            (click)="onDifficultyChange('hard')"
          >
            Hard
          </button>
          <button
            class="px-3 py-1 rounded text-sm cursor-pointer"
            [class.bg-blue-600]="settings.difficulty() === 'nightmare'"
            [class.bg-gray-700]="settings.difficulty() !== 'nightmare'"
            (click)="onDifficultyChange('nightmare')"
          >
            Nightmare
          </button>
        </div>
      </div>
      <div class="mb-3">
        <label class="text-sm mb-1 block">Map Size</label>
        <div class="flex gap-2">
          <button
            class="px-3 py-1 rounded text-sm cursor-pointer"
            [class.bg-indigo-600]="settings.mapSize() === 10"
            [class.bg-gray-700]="settings.mapSize() !== 10"
            (click)="onMapSizeChange(10)"
          >
            10x10
          </button>
          <button
            class="px-3 py-1 rounded text-sm cursor-pointer"
            [class.bg-indigo-600]="settings.mapSize() === 20"
            [class.bg-gray-700]="settings.mapSize() !== 20"
            (click)="onMapSizeChange(20)"
          >
            20x20
          </button>
          <button
            class="px-3 py-1 rounded text-sm cursor-pointer"
            [class.bg-indigo-600]="settings.mapSize() === 30"
            [class.bg-gray-700]="settings.mapSize() !== 30"
            (click)="onMapSizeChange(30)"
          >
            30x30
          </button>
        </div>
      </div>
    </div>
  }
  @if (gameEngine.highScoresOpen()) {
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-600 w-[680px] max-w-[95vw]">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-2xl font-bold">High Scores</h2>
          <button
            class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-700 hover:bg-gray-600 text-lg cursor-pointer"
            (click)="gameEngine.closeHighScores()"
          >
            ‚úñ
          </button>
        </div>
        <div class="text-sm text-gray-300 mb-2">
          Current: {{ settings.difficultyLabel() }} ‚Ä¢ {{ settings.mapSizeLabel() }}
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-gray-800/60 border border-gray-700 rounded-lg p-3">
            <h3 class="text-lg font-semibold mb-2 text-green-400">Player Wins (Top 3)</h3>
            @for (s of gameEngine.getHighScoresForCurrentCombo().wins; track s.date) {
              <div class="flex justify-between text-sm">
                <span>{{ s.date | date: 'yyyy-MM-dd HH:mm' }}</span>
                <span class="font-mono">{{ s.condition }}</span>
                <span class="font-mono text-yellow-300">{{ s.turns }} turns</span>
              </div>
            } @empty {
              <div class="text-xs text-gray-400">No records yet</div>
            }
          </div>
          <div class="bg-gray-800/60 border border-gray-700 rounded-lg p-3">
            <h3 class="text-lg font-semibold mb-2 text-red-400">Player Losses (Top 3)</h3>
            @for (s of gameEngine.getHighScoresForCurrentCombo().losses; track s.date) {
              <div class="flex justify-between text-sm">
                <span>{{ s.date | date: 'yyyy-MM-dd HH:mm' }}</span>
                <span class="font-mono">{{ s.condition }}</span>
                <span class="font-mono text-yellow-300">{{ s.turns }} turns</span>
              </div>
            } @empty {
              <div class="text-xs text-gray-400">No records yet</div>
            }
          </div>
        </div>
        <div class="mt-4 text-xs text-gray-400">Change Difficulty or Map Size in Settings to view other boards.</div>
      </div>
    </div>
  }

  @if (!isProduction) {
    <div
      class="fixed bottom-10 left-4 z-[9999] flex flex-col gap-2 bg-black/80 p-2 rounded border border-red-500 shadow-lg backdrop-blur-sm"
    >
      <div class="text-red-500 font-bold text-xs uppercase text-center mb-1 border-b border-red-900/50 pb-1">
        Debug Mode
      </div>
      <button
        (click)="gameEngine.debugInstantWin()"
        class="bg-red-900/40 hover:bg-red-800/60 text-red-100 text-xs px-3 py-1.5 rounded border border-red-800 transition-colors cursor-pointer"
      >
        ‚ö° Instant Win
      </button>
      <button
        (click)="gameEngine.debugCycleSettings()"
        class="bg-blue-900/40 hover:bg-blue-800/60 text-blue-100 text-xs px-3 py-1.5 rounded border border-blue-800 transition-colors cursor-pointer"
      >
        üîÑ Cycle Settings
      </button>
      <div class="text-[10px] text-gray-400 text-center font-mono mt-1">
        {{ settings.difficultyLabel() }} | {{ settings.mapSizeLabel() }}
      </div>
    </div>
  }
</div>
