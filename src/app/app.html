<div class="min-h-screen bg-gray-900 text-white flex flex-col items-center justify-center p-4">
  <div class="w-full max-w-4xl flex items-center justify-between mb-4">
    <h1 class="text-3xl font-bold">Turn-Based Strategy</h1>
    <button
      class="flex items-center gap-1 px-3 py-1 rounded-full bg-gray-700 hover:bg-gray-600 text-sm cursor-pointer"
      (click)="gameEngine.toggleRules()"
    >
      <span class="w-5 h-5 flex items-center justify-center rounded-full bg-blue-500 text-white text-sm">?</span>
      <span>Rules</span>
    </button>
    <button
      class="flex items-center gap-1 px-3 py-1 rounded-full bg-gray-700 hover:bg-gray-600 text-sm cursor-pointer"
      (click)="gameEngine.toggleHighScores()"
    >
      <span class="w-5 h-5 flex items-center justify-center rounded-full bg-yellow-500 text-white text-sm">üèÜ</span>
      <span>High Scores</span>
    </button>
    <button
      class="flex items-center gap-1 px-3 py-1 rounded-full bg-gray-700 hover:bg-gray-600 text-sm cursor-pointer"
      (click)="gameEngine.toggleSettings()"
    >
      <span class="w-5 h-5 flex items-center justify-center rounded-full bg-gray-500 text-white text-sm">‚öôÔ∏è</span>
      <span>Settings</span>
    </button>
    <button
      class="flex items-center gap-1 px-3 py-1 rounded-full bg-gray-700 hover:bg-gray-600 text-sm cursor-pointer"
      (click)="gameEngine.toggleLog()"
    >
      <span class="w-5 h-5 flex items-center justify-center rounded-full bg-teal-500 text-white text-sm">‚Ñπ</span>
      <span>Log</span>
    </button>
  </div>
  <div
    class="w-full max-w-4xl flex items-center justify-between mb-3 px-3 py-2 rounded-xl bg-white/5 backdrop-blur border border-gray-600/30"
  >
    <div class="flex items-center gap-4 text-xs">
      <span class="text-blue-300 font-semibold text-base">Player</span>
      <span class="flex items-center gap-1">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="7" y="14" width="13" height="6" rx="3" fill="#8B5E3C" />
          <circle cx="7" cy="17" r="3" fill="#A67B5B" stroke="#724A2D" stroke-width="1" />
          <circle cx="7" cy="17" r="1.5" stroke="#724A2D" stroke-width="0.5" />

          <rect x="7" y="5" width="13" height="6" rx="3" fill="#A67B5B" />
          <circle cx="7" cy="8" r="3" fill="#C49A6C" stroke="#8B5E3C" stroke-width="1" />
          <circle cx="7" cy="8" r="1.5" stroke="#8B5E3C" stroke-width="0.5" />
        </svg>
        <span>:</span>
        <span class="font-mono text-green-400 mt-[4px]">{{ gameEngine.resources().wood }}</span>
      </span>
      <span class="flex items-center gap-1">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="0" y="0" width="24" height="24" fill="" />

          <circle cx="6" cy="10" r="5" fill="#388E3C" />
          <circle cx="14" cy="8" r="6" fill="#4CAF50" />
          <circle cx="20" cy="12" r="4" fill="#388E3C" />
          <circle cx="10" cy="16" r="5" fill="#4CAF50" />

          <rect x="4" y="14" width="2" height="10" fill="#8B5E3C" />
          <rect x="12" y="12" width="2" height="12" fill="#8B5E3C" />
          <rect x="18" y="16" width="2" height="8" fill="#8B5E3C" />
        </svg>
        <span>:</span>
        <span class="font-mono text-blue-300 mt-[4px]">
          {{ gameEngine.getForestControl().player }}/{{ gameEngine.getForestControl().total }}
        </span>
      </span>
    </div>
    <div class="text-sm inline-flex gap-[8px]">
      <span class="text-gray-300">Turn:</span>
      <span class="font-bold text-yellow-400">{{ gameEngine.turn() }}</span>
      @if (gameEngine.gameStatus() !== 'playing') {
        <span class="ml-2 text-xs font-bold text-red-400">{{ gameEngine.gameStatus() | titlecase }}</span>
      }
    </div>
    <div class="flex items-center gap-4 text-xs">
      <span class="text-red-300 font-semibold text-base">AI</span>
      <span class="flex inline-flex items-center gap-1">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="7" y="14" width="13" height="6" rx="3" fill="#8B5E3C" />
          <circle cx="7" cy="17" r="3" fill="#A67B5B" stroke="#724A2D" stroke-width="1" />
          <circle cx="7" cy="17" r="1.5" stroke="#724A2D" stroke-width="0.5" />

          <rect x="7" y="5" width="13" height="6" rx="3" fill="#A67B5B" />
          <circle cx="7" cy="8" r="3" fill="#C49A6C" stroke="#8B5E3C" stroke-width="1" />
          <circle cx="7" cy="8" r="1.5" stroke="#8B5E3C" stroke-width="0.5" />
        </svg>
        <span>:</span>
        <span class="font-mono text-red-400 mt-[4px]">{{ gameEngine.aiWood() }}</span>
      </span>
      <span class="flex items-center gap-1">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="0" y="0" width="24" height="24" fill="" />

          <circle cx="6" cy="10" r="5" fill="#388E3C" />
          <circle cx="14" cy="8" r="6" fill="#4CAF50" />
          <circle cx="20" cy="12" r="4" fill="#388E3C" />
          <circle cx="10" cy="16" r="5" fill="#4CAF50" />

          <rect x="4" y="14" width="2" height="10" fill="#8B5E3C" />
          <rect x="12" y="12" width="2" height="12" fill="#8B5E3C" />
          <rect x="18" y="16" width="2" height="8" fill="#8B5E3C" />
        </svg>
        <span>:</span>
        <span class="font-mono text-red-300 mt-[4px]">
          {{ gameEngine.getForestControl().ai }}/{{ gameEngine.getForestControl().total }}
        </span>
      </span>
    </div>
  </div>

  @if (gameEngine.shouldShowEndOverlay()) {
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-600 text-center">
        <h2
          class="text-4xl font-bold mb-4"
          [class.text-blue-400]="gameEngine.gameStatus() === 'player wins'"
          [class.text-red-500]="gameEngine.gameStatus() === 'ai wins'"
        >
          {{ gameEngine.gameStatus() | titlecase }}!
        </h2>
        @if (gameEngine.endReason()) {
          <div class="text-sm text-gray-300 mb-4">{{ gameEngine.endReason() }}</div>
        }
        <button
          (click)="gameEngine.resetGame()"
          class="px-6 py-3 bg-green-600 hover:bg-green-500 rounded text-white font-bold text-lg cursor-pointer"
        >
          Play Again
        </button>
      </div>
    </div>
  }
  <button
    class="fixed bottom-4 right-4 z-50 px-4 py-2 rounded-full bg-pink-600 hover:bg-pink-500 text-white shadow-xl cursor-pointer flex items-center gap-2"
    (click)="gameEngine.toggleSupport()"
    aria-label="Support the Project"
  >
    <span class="text-lg">‚ù§Ô∏è</span>
    <span class="text-lg mb-[2px]">Support</span>
  </button>
  @if (gameEngine.supportOpen()) {
    <app-support-community />
  }

  <style>
    * {
      box-sizing: border-box;
    }
    .tile {
      min-width: 64px;
      min-height: 64px;
      aspect-ratio: 1 / 1;
      position: relative;
    }
    .combat-text-anim {
      animation: combatFloat 0.5s ease-out;
    }
    @keyframes combatFloat {
      from {
        transform: translateY(0);
      }
      to {
        transform: translateY(-12px);
      }
    }
    .shake {
      animation: defenderShake 200ms ease-out;
    }
    @keyframes defenderShake {
      0% {
        transform: translate(0, 0);
      }
      25% {
        transform: translate(2px, -2px);
      }
      50% {
        transform: translate(-2px, 2px);
      }
      75% {
        transform: translate(2px, 2px);
      }
      100% {
        transform: translate(0, 0);
      }
    }
    .arrival-pop {
      animation: arrivalPop 200ms ease-out;
    }
    @keyframes arrivalPop {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
      100% {
        transform: scale(1);
      }
    }
    .pulse-glow {
      animation: pulseGlow 400ms ease-out;
    }
    @keyframes pulseGlow {
      0% {
        box-shadow: 0 0 0px rgba(255, 215, 0, 0);
      }
      50% {
        box-shadow: 0 0 12px rgba(255, 215, 0, 0.8);
      }
      100% {
        box-shadow: 0 0 0px rgba(255, 215, 0, 0);
      }
    }
    .wood-pulse-icon {
      animation: woodPulse 1000ms ease-in-out infinite;
      filter: drop-shadow(0 0 4px rgba(16, 185, 129, 0.7));
    }
    @keyframes woodPulse {
      0% {
        transform: scale(0.9);
        opacity: 0.6;
      }
      50% {
        transform: scale(1.1);
        opacity: 1;
      }
      100% {
        transform: scale(0.9);
        opacity: 0.6;
      }
    }
  </style>
  <div
    #boardContainer
    [class.shake]="gameEngine.screenShake()"
    [class.mood-none]="gameEngine.currentMood() === 'none'"
    [class.mood-angry]="gameEngine.currentMood() === 'angry'"
    [class.mood-rage]="gameEngine.currentMood() === 'rage'"
    class="max-w-[90vw] max-h-[90vh] overflow-auto bg-gray-800 p-2 rounded-lg border border-gray-700 select-none relative mx-auto my-auto"
  >
    <div
      class="grid"
      [style.gridTemplateColumns]="
        'repeat(' +
        gameEngine.gridSize +
        ', minmax(' +
        gameEngine.tileMinSizePx +
        'px, ' +
        gameEngine.tileSizePx +
        'px))'
      "
      [style.gap.px]="gameEngine.wallThicknessPx"
    >
      <!-- Base Indicators -->
      <div
        class="absolute top-2 left-2 w-12 h-12 border-2 border-blue-500/30 rounded pointer-events-none flex items-center justify-center"
      >
        <span class="text-white font-bold bg-blue-600 px-1 rounded shadow text-xs">
          {{ gameEngine.baseHealth().player }}
        </span>
      </div>
      @if (gameEngine.isVisibleToPlayer(gameEngine.gridSize - 1, gameEngine.gridSize - 1)) {
        <div
          class="absolute bottom-2 right-2 w-12 h-12 border-2 border-red-500/30 rounded pointer-events-none flex items-center justify-center"
        >
          <span class="text-white font-bold bg-red-600 px-1 rounded shadow text-xs">
            {{ gameEngine.baseHealth().ai }}
          </span>
        </div>
      }

      @for (y of gameEngine.gridRows; track y) {
        @for (x of gameEngine.gridCols; track x) {
          <div
            (click)="onTileClick(x, y)"
            class="tile rounded flex items-center justify-center border transition-colors duration-200"
            [style.width.px]="gameEngine.tileSizePx"
            [style.height.px]="gameEngine.tileSizePx"
            [style.minWidth.px]="gameEngine.tileMinSizePx"
            [style.minHeight.px]="gameEngine.tileMinSizePx"
            [class.cursor-pointer]="gameEngine.isValidMove(x, y)"
            [attr.title]="
              gameEngine.getUnitAt(x, y) &&
              (gameEngine.getUnitAt(x, y)!.owner === 'player' || gameEngine.isVisibleToPlayer(x, y))
                ? gameEngine.formatHoverInfo(gameEngine.getUnitAt(x, y)!.id)
                : null
            "
            [class.bg-gray-700]="!gameEngine.isValidMove(x, y)"
            [class.border-gray-600]="!gameEngine.isValidMove(x, y)"
            [class.bg-blue-900]="x === 0 && y === 0"
            [class.bg-red-900]="x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1"
            [class.border-4]="(x === 0 && y === 0) || (x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1)"
            [class.border-blue-400]="x === 0 && y === 0"
            [class.border-red-400]="x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1"
            [class.ring-2]="(x === 0 && y === 0) || (x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1)"
            [class.ring-blue-300]="x === 0 && y === 0 && gameEngine.baseDeployActive()"
            [class.ring-red-300]="x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1"
            [class.spawn-zone-highlight]="gameEngine.baseDeployActive() && x <= 2 && y <= 2 && (x !== 0 || y !== 0)"
            [style.backgroundColor]="gameEngine.isForest(x, y) ? '#795548' : null"
            [class.bg-amber-900]="gameEngine.isDeployTarget(x, y) && !gameEngine.buildMode()"
            [class.border-amber-500]="gameEngine.isDeployTarget(x, y) && !gameEngine.buildMode()"
            [class.bg-gray-950]="!gameEngine.isVisibleToPlayer(x, y)"
            [class.border-gray-800]="!gameEngine.isVisibleToPlayer(x, y)"
            [class.bg-green-900]="gameEngine.isValidMove(x, y) && !gameEngine.getUnitAt(x, y)"
            [class.border-green-500]="gameEngine.isValidMove(x, y) && !gameEngine.getUnitAt(x, y)"
            [class.bg-cyan-900]="gameEngine.isValidMove(x, y) && gameEngine.getUnitAt(x, y)"
            [class.border-cyan-500]="gameEngine.isValidMove(x, y) && gameEngine.getUnitAt(x, y)"
            [class.animate-pulse]="gameEngine.isValidMove(x, y) && gameEngine.getUnitAt(x, y)"
            [class.hover:bg-gray-600]="!gameEngine.isValidMove(x, y)"
            [class.hover:bg-green-800]="gameEngine.isValidMove(x, y) && !gameEngine.getUnitAt(x, y)"
            [class.hover:bg-cyan-800]="gameEngine.isValidMove(x, y) && gameEngine.getUnitAt(x, y)"
          >
            <!-- Grid coordinate helper -->
            <span class="absolute top-0 right-0 text-[8px] text-gray-500 p-0.5 pointer-events-none">
              {{ x }},{{ y }}
            </span>
            @if (x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1 && gameEngine.isVisibleToPlayer(x, y)) {
              @if (gameEngine.isRage()) {
                <span
                  class="absolute -top-2 -right-2 text-xl [filter:drop-shadow(0_0_2px_rgba(0,0,0,0.5))]"
                  [style.z-index]="100"
                >
                  ü§¨
                </span>
              } @else if (gameEngine.isAngry()) {
                <span
                  class="absolute -top-2 -right-2 text-xl [filter:drop-shadow(0_0_2px_rgba(0,0,0,0.5))]"
                  [style.z-index]="100"
                >
                  üò†
                </span>
              }
            }
            @if (gameEngine.buildMode() && gameEngine.isInSafeZone(x, y)) {
              <div
                class="absolute inset-0 bg-red-800/20 border-2 border-red-500/40 border-dashed pointer-events-none"
              ></div>
            }
            @if (gameEngine.isForest(x, y) && gameEngine.isVisibleToPlayer(x, y)) {
              <span
                class="absolute text-[10px] text-amber-300 font-bold pointer-events-none"
                [style.left.px]="1"
                [style.bottom.px]="1"
              >
                W
              </span>
            }
            @if (gameEngine.isForest(x, y) && gameEngine.getUnitAt(x, y) && gameEngine.isVisibleToPlayer(x, y)) {
              <div
                class="absolute top-0 left-0 right-0 bg-green-400/70 pointer-events-none"
                [style.height.px]="2"
              ></div>
            }
            @if (x === 0 && y === 0) {
              <span
                class="absolute inset-x-0 top-0 m-0.5 text-[10px] font-extrabold text-blue-900 bg-blue-300/80 rounded px-1 pointer-events-none"
              >
                {{ gameEngine.baseHealth().player }}
              </span>
              <span
                class="absolute left-0 bottom-0 m-0.5 text-[10px] font-extrabold text-white bg-blue-600/90 rounded px-1 pointer-events-none"
              >
                {{ gameEngine.reservePoints().player }}
              </span>
            }
            @if (x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1) {
              @if (gameEngine.isVisibleToPlayer(x, y)) {
                <span
                  class="absolute inset-x-0 top-0 m-0.5 text-[10px] font-extrabold text-red-900 bg-red-300/80 rounded px-1 pointer-events-none"
                >
                  {{ gameEngine.baseHealth().ai }}
                </span>
                <span
                  class="absolute right-0 bottom-0 m-0.5 text-[10px] font-extrabold text-white bg-red-600/90 rounded px-1 pointer-events-none"
                >
                  {{ gameEngine.reservePoints().ai }}
                </span>
              }
            }

            @if (x < gameEngine.gridSize - 1) {
              @if (gameEngine.getWallBetween(x, y, x + 1, y); as vWall) {
                @if (gameEngine.shouldRenderWall({ x: x, y: y }, { x: x + 1, y: y }, vWall.owner)) {
                  <div
                    class="absolute right-0 top-0 h-full flex items-center justify-center"
                    [style.right.px]="-gameEngine.wallThicknessPx"
                    [style.width.px]="gameEngine.wallThicknessPx"
                    [style.height.%]="vWall.health"
                    [style.z-index]="40"
                    [style.transition]="'height 0.25s ease-out'"
                    [class.bg-lime-400]="vWall.owner === 'player'"
                    [class.bg-red-400]="vWall.owner === 'ai'"
                    [class.bg-gray-300]="vWall.owner === 'neutral'"
                    [class.shake]="gameEngine.isWallShaking(vWall.id)"
                  >
                    @if (gameEngine.canShowAttackIcon({ x: x, y: y }, { x: x + 1, y: y })) {
                      <button
                        class="rounded-full shadow-lg flex items-center justify-center text-white"
                        [style.width.px]="gameEngine.iconSizePx"
                        [style.height.px]="gameEngine.iconSizePx"
                        [style.z-index]="45"
                        [class.bg-red-600]="vWall.owner === 'player'"
                        [class.bg-yellow-500]="vWall.owner === 'ai'"
                        [class.bg-gray-600]="vWall.owner === 'neutral'"
                        (click)="
                          vWall.owner === 'player'
                            ? onDestroyIconClick($event, x, y, x + 1, y)
                            : onAttackIconClick($event, x, y, x + 1, y)
                        "
                      >
                        {{ vWall.owner === 'player' ? '‚úñ' : '‚öî' }}
                      </button>
                    }
                  </div>
                }
              } @else {
                <div
                  class="absolute right-0 top-0 h-full flex items-center justify-center"
                  [style.right.px]="-gameEngine.wallThicknessPx"
                  [style.width.px]="gameEngine.wallThicknessPx"
                  [style.height.%]="100"
                  [style.z-index]="40"
                  [style.transition]="'height 0.25s ease-out'"
                  [class.bg-lime-700]="
                    gameEngine.buildMode() && gameEngine.canBuildWallBetween({ x: x, y: y }, { x: x + 1, y: y })
                  "
                  [class.bg-transparent]="
                    !gameEngine.buildMode() || !gameEngine.canBuildWallBetween({ x: x, y: y }, { x: x + 1, y: y })
                  "
                >
                  @if (gameEngine.canShowBuildIcon({ x: x, y: y }, { x: x + 1, y: y })) {
                    <button
                      class="bg-green-500 text-white rounded-full shadow-lg flex items-center justify-center"
                      [style.fontSize.px]="gameEngine.iconSizePx"
                      [style.width.px]="gameEngine.iconSizePx"
                      [style.height.px]="gameEngine.iconSizePx"
                      [style.z-index]="45"
                      (click)="onBuildIconClick($event, x, y, x + 1, y)"
                    >
                      ‚úî
                    </button>
                  }
                  @if (
                    (gameEngine.isVisibleToPlayer(x, y) || gameEngine.isVisibleToPlayer(x + 1, y)) &&
                    gameEngine.edgeCooldownRemaining({ x: x, y: y }, { x: x + 1, y: y }) > 0
                  ) {
                    <span class="absolute whitespace-nowrap right-0 top-0 text-[10px] text-yellow-300 px-1">
                      CD: {{ gameEngine.edgeCooldownRemaining({ x: x, y: y }, { x: x + 1, y: y }) }}
                    </span>
                  }
                </div>
              }
            }

            @if (y < gameEngine.gridSize - 1) {
              @if (gameEngine.getWallBetween(x, y, x, y + 1); as hWall) {
                @if (gameEngine.shouldRenderWall({ x: x, y: y }, { x: x, y: y + 1 }, hWall.owner)) {
                  <div
                    class="absolute left-0 bottom-0 w-full flex items-center justify-center"
                    [style.bottom.px]="-gameEngine.wallThicknessPx"
                    [style.height.px]="gameEngine.wallThicknessPx"
                    [style.width.%]="hWall.health"
                    [style.z-index]="40"
                    [style.transition]="'width 0.25s ease-out'"
                    [class.bg-lime-400]="hWall.owner === 'player'"
                    [class.bg-red-400]="hWall.owner === 'ai'"
                    [class.bg-gray-300]="hWall.owner === 'neutral'"
                    [class.shake]="gameEngine.isWallShaking(hWall.id)"
                  >
                    @if (gameEngine.canShowAttackIcon({ x: x, y: y }, { x: x, y: y + 1 })) {
                      <button
                        class="rounded-full shadow-lg flex items-center justify-center text-white"
                        [style.width.px]="gameEngine.iconSizePx"
                        [style.height.px]="gameEngine.iconSizePx"
                        [style.z-index]="45"
                        [class.bg-red-600]="hWall.owner === 'player'"
                        [class.bg-yellow-500]="hWall.owner === 'ai'"
                        [class.bg-gray-600]="hWall.owner === 'neutral'"
                        (click)="
                          hWall.owner === 'player'
                            ? onDestroyIconClick($event, x, y, x, y + 1)
                            : onAttackIconClick($event, x, y, x, y + 1)
                        "
                      >
                        {{ hWall.owner === 'player' ? '‚úñ' : '‚öî' }}
                      </button>
                    }
                  </div>
                }
              } @else {
                <div
                  class="absolute left-0 bottom-0 w-full flex items-center justify-center"
                  [style.bottom.px]="-gameEngine.wallThicknessPx"
                  [style.height.px]="gameEngine.wallThicknessPx"
                  [style.width.%]="100"
                  [style.z-index]="40"
                  [style.transition]="'width 0.25s ease-out'"
                  [class.bg-lime-700]="
                    gameEngine.buildMode() && gameEngine.canBuildWallBetween({ x: x, y: y }, { x: x, y: y + 1 })
                  "
                  [class.bg-transparent]="
                    !gameEngine.buildMode() || !gameEngine.canBuildWallBetween({ x: x, y: y }, { x: x, y: y + 1 })
                  "
                >
                  @if (gameEngine.canShowBuildIcon({ x: x, y: y }, { x: x, y: y + 1 })) {
                    <button
                      class="bg-green-500 text-white rounded-full shadow-lg flex items-center justify-center"
                      [style.fontSize.px]="gameEngine.iconSizePx"
                      [style.width.px]="gameEngine.iconSizePx"
                      [style.height.px]="gameEngine.iconSizePx"
                      [style.z-index]="45"
                      (click)="onBuildIconClick($event, x, y, x, y + 1)"
                    >
                      ‚úî
                    </button>
                  }
                  @if (
                    (gameEngine.isVisibleToPlayer(x, y) || gameEngine.isVisibleToPlayer(x, y + 1)) &&
                    gameEngine.edgeCooldownRemaining({ x: x, y: y }, { x: x, y: y + 1 }) > 0
                  ) {
                    <span class="absolute whitespace-nowrap left-0 bottom-0 text-[10px] text-yellow-300 px-1">
                      CD: {{ gameEngine.edgeCooldownRemaining({ x: x, y: y }, { x: x, y: y + 1 }) }}
                    </span>
                  }
                </div>
              }
            }

            @if (gameEngine.getUnitAt(x, y); as unit) {
              @if (unit.owner === 'player' || gameEngine.isVisibleToPlayer(x, y)) {
                @if (!(x === 0 && y === 0) && !(x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1)) {
                  <div
                    class="pointer-events-none"
                    [style.transition]="'transform 150ms ease-out'"
                    [style.transform]="
                      gameEngine.getNudgeFor(unit.id)
                        ? 'translate(' +
                          gameEngine.getNudgeFor(unit.id)!.dx +
                          'px,' +
                          gameEngine.getNudgeFor(unit.id)!.dy +
                          'px)'
                        : 'translate(0,0)'
                    "
                    [class.shake]="gameEngine.isUnitShaking(unit.id)"
                  >
                    <div
                      class="flex items-center justify-center font-bold transition-all duration-300 shadow-lg"
                      [style.width.px]="gameEngine.tileUnitSizePx"
                      [style.height.px]="gameEngine.tileUnitSizePx"
                      [style.aspectRatio]="'1 / 1'"
                      [attr.title]="gameEngine.formatHoverInfo(unit.id)"
                      [class.bg-blue-500]="unit.owner === 'player'"
                      [class.bg-red-500]="unit.owner === 'ai'"
                      [class.text-white]="true"
                      [class.rounded-full]="unit.tier === 1"
                      [class.border-2]="unit.tier !== 2"
                      [class.border-blue-300]="unit.owner === 'player' && unit.tier !== 2"
                      [class.border-red-300]="unit.owner === 'ai' && unit.tier !== 2"
                      [class.rounded-none]="unit.tier === 3"
                      [class.rotate-45]="unit.tier === 4"
                      [class.scale-75]="unit.tier === 4"
                      [style.clip-path]="unit.tier === 2 ? 'polygon(50% 0%, 0% 100%, 100% 100%)' : ''"
                      [style.padding-top]="unit.tier === 2 ? '0.25rem' : ''"
                      [class.ring-4]="gameEngine.selectedUnitId() === unit.id"
                      [class.ring-yellow-400]="gameEngine.selectedUnitId() === unit.id"
                      [class.ring-offset-2]="gameEngine.selectedUnitId() === unit.id"
                      [class.ring-offset-gray-800]="gameEngine.selectedUnitId() === unit.id"
                      [class.scale-110]="
                        gameEngine.selectedUnitId() === unit.id && unit.tier !== 4 && !gameEngine.buildMode()
                      "
                      [class.scale-90]="
                        gameEngine.selectedUnitId() === unit.id && unit.tier === 4 && !gameEngine.buildMode()
                      "
                      [class.scale-125]="gameEngine.lastMergedUnitId() === unit.id"
                      [class.scale-50]="gameEngine.buildMode()"
                      [class.animate-bounce]="gameEngine.lastRemainderUnitId() === unit.id"
                      [class.arrival-pop]="gameEngine.lastArrivedUnitId() === unit.id"
                      [class.pulse-glow]="gameEngine.pulseUnitId() === unit.id"
                    >
                      <span [class.-rotate-45]="unit.tier === 4">{{ unit.level }}</span>
                    </div>
                    @if (gameEngine.hasDefenseBonus(unit)) {
                      <span
                        class="absolute -top-1 -right-1 rounded-full bg-blue-200 text-blue-900 flex items-center justify-center"
                        [style.width.px]="gameEngine.iconSizePx"
                        [style.height.px]="gameEngine.iconSizePx"
                        [style.fontSize.px]="gameEngine.iconSizePx - 2 > 8 ? gameEngine.iconSizePx - 2 : 8"
                        [style.z-index]="100"
                      >
                        üõ°
                      </span>
                    }
                    @if (unit.productionActive) {
                      <span
                        class="absolute -bottom-1 -right-1 [filter:drop-shadow(0_0_2px_rgba(0,0,0,0.5))]"
                        [style.z-index]="100"
                      >
                        <!-- <svg [style.width.px]="gameEngine.iconSizePx" [style.height.px]="gameEngine.iconSizePx" viewBox="0 0 16 16">
                          <rect x="7" y="9" width="2" height="6" fill="#8B5A2B"></rect>
                          <circle cx="8" cy="7" r="5" fill="#22c55e"></circle>
                        </svg> -->
                        üå≥
                      </span>
                    } @else if ((unit.forestOccupationTurns ?? 0) > 0) {
                      <span
                        class="absolute -bottom-1 -right-1 opacity-70 [filter:drop-shadow(0_0_2px_rgba(0,0,0,0.5))]"
                        [style.z-index]="100"
                      >
                        <!-- <svg [style.width.px]="gameEngine.iconSizePx" [style.height.px]="gameEngine.iconSizePx" viewBox="0 0 16 16">
                          <rect x="7" y="9" width="2" height="6" fill="#8B5A2B"></rect>
                          <circle cx="8" cy="7" r="5" fill="none" stroke="#22c55e" stroke-width="2"></circle>
                        </svg> -->
                        üå±
                      </span>
                    }
                  </div>
                }
              }
            }

            @for (entry of gameEngine.getCombatTextEntriesAt(x, y); track entry.id) {
              <div
                class="absolute inset-0 flex items-center justify-center pointer-events-none transition-opacity duration-500 combat-text-anim"
                [style.z-index]="100"
                [style.opacity]="entry.opacity"
              >
                <span
                  [class.text-xs]="!gameEngine.isLuckyText(entry.text) && !gameEngine.isDrawText(entry.text)"
                  [class.text-base]="gameEngine.isLuckyText(entry.text) || gameEngine.isDrawText(entry.text)"
                  [class.text-yellow-300]="!gameEngine.isLuckyText(entry.text) && !gameEngine.isDrawText(entry.text)"
                  [class.text-yellow-400]="gameEngine.isLuckyText(entry.text) || gameEngine.isDrawText(entry.text)"
                  class="font-extrabold"
                >
                  {{ entry.text }}
                </span>
              </div>
            }
          </div>
        }
      }
    </div>
  </div>

  <div class="mt-4 flex flex-col items-center gap-3">
    <div class="flex gap-4 items-center">
      <button
        (click)="gameEngine.toggleBuildMode()"
        class="px-4 py-2 rounded-xl text-sm cursor-pointer bg-gradient-to-b from-blue-600 to-blue-800 text-white shadow-inner hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0.5 transition transform flex items-center gap-2"
        [class.opacity-50]="gameEngine.wallBuiltThisTurn() || !gameEngine.canBuildThisTurn()"
        [disabled]="gameEngine.wallBuiltThisTurn() || !gameEngine.canBuildThisTurn()"
      >
        <span>üß±</span>
        <span class="inline-flex items-center">
          <span>Build Wall (-10</span>
          <span>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="7" y="14" width="13" height="6" rx="3" fill="#8B5E3C" />
              <circle cx="7" cy="17" r="3" fill="#A67B5B" stroke="#724A2D" stroke-width="1" />
              <circle cx="7" cy="17" r="1.5" stroke="#724A2D" stroke-width="0.5" />

              <rect x="7" y="5" width="13" height="6" rx="3" fill="#A67B5B" />
              <circle cx="7" cy="8" r="3" fill="#C49A6C" stroke="#8B5E3C" stroke-width="1" />
              <circle cx="7" cy="8" r="1.5" stroke="#8B5E3C" stroke-width="0.5" />
            </svg>
          </span>
          <span>)</span>
        </span>
      </button>
      <button
        (click)="gameEngine.convertWoodToReserve()"
        class="px-4 py-2 rounded-xl text-sm cursor-pointer bg-gradient-to-b from-blue-600 to-blue-800 text-white shadow-inner hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0.5 transition transform flex items-center gap-2"
      >
        <span class="inline-flex items-center gap-[4px]">
          <span>20</span>
          <span>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="7" y="14" width="13" height="6" rx="3" fill="#8B5E3C" />
              <circle cx="7" cy="17" r="3" fill="#A67B5B" stroke="#724A2D" stroke-width="1" />
              <circle cx="7" cy="17" r="1.5" stroke="#724A2D" stroke-width="0.5" />

              <rect x="7" y="5" width="13" height="6" rx="3" fill="#A67B5B" />
              <circle cx="7" cy="8" r="3" fill="#C49A6C" stroke="#8B5E3C" stroke-width="1" />
              <circle cx="7" cy="8" r="1.5" stroke="#8B5E3C" stroke-width="0.5" />
            </svg>
          </span>
          <span>‚Üí +1 üë§</span>
        </span>
      </button>
      <button
        (click)="gameEngine.maxConvertWoodToReserve()"
        class="px-4 py-2 rounded-xl text-sm cursor-pointer bg-gradient-to-b from-blue-600 to-blue-800 text-white shadow-inner hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0.5 transition transform flex items-center gap-2"
      >
        <span>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="7" y="14" width="13" height="6" rx="3" fill="#8B5E3C" />
            <circle cx="7" cy="17" r="3" fill="#A67B5B" stroke="#724A2D" stroke-width="1" />
            <circle cx="7" cy="17" r="1.5" stroke="#724A2D" stroke-width="0.5" />

            <rect x="7" y="5" width="13" height="6" rx="3" fill="#A67B5B" />
            <circle cx="7" cy="8" r="3" fill="#C49A6C" stroke="#8B5E3C" stroke-width="1" />
            <circle cx="7" cy="8" r="1.5" stroke="#8B5E3C" stroke-width="0.5" />
          </svg>
        </span>
        <span>MAX ‚Üí ++üë•</span>
      </button>
    </div>
    <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
      <input
        type="checkbox"
        class="h-4 w-4 rounded border-gray-500 bg-gray-800 cursor-pointer"
        [checked]="gameEngine.fogDebugDisabled()"
        (change)="gameEngine.toggleFogDebug()"
      />
      <span>Disable Fog of War (Debug)</span>
    </label>
  </div>
  <!-- <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
    <input
      type="checkbox"
      class="h-4 w-4 rounded border-gray-500 bg-gray-800 cursor-pointer"
      [checked]="gameEngine.autoDeployEnabled()"
      (change)="gameEngine.toggleAutoDeploy()"
    />
    <span>Auto-Deploy</span>
  </label> -->
  <div class="fixed bottom-4 left-4 text-[12px] text-gray-500">version: 0.2.3 | Created by jaerbi and just</div>

  @if (gameEngine.rulesOpen()) {
    <app-game-rules />
  }
  @if (gameEngine.logOpen()) {
    <div class="fixed inset-y-0 right-0 w-80 bg-gray-900/90 border-l border-gray-700 p-4 z-40">
      <h3 class="text-lg font-bold mb-2">Action Log</h3>
      <label class="flex items-center gap-2 text-xs text-gray-300 mb-2 cursor-pointer">
        <input
          type="checkbox"
          class="h-4 w-4 rounded border-gray-500 bg-gray-800 cursor-pointer"
          [checked]="gameEngine.combatOnly()"
          (change)="gameEngine.toggleCombatOnly()"
        />
        <span>Combat Only</span>
      </label>
      <div class="h-[78vh] overflow-y-auto space-y-2 text-xs">
        @for (entry of gameEngine.logsFiltered(); track entry.text) {
          <div [class]="entry.color">{{ entry.text }}</div>
        }
      </div>
    </div>
  }
  @if (gameEngine.settingsOpen()) {
    <div class="fixed inset-y-0 left-0 w-64 bg-gray-900/90 border-r border-gray-700 p-4 z-40">
      <h3 class="text-lg font-bold mb-2">Settings</h3>
      <div class="mb-3">
        <label class="text-sm mb-1 block">Difficulty</label>
        <div class="flex gap-2">
          <button
            class="px-3 py-1 rounded text-sm cursor-pointer"
            [class.bg-blue-600]="settings.difficulty() === 'normal'"
            [class.bg-gray-700]="settings.difficulty() !== 'normal'"
            (click)="settings.setDifficulty('normal')"
          >
            Normal
          </button>
          <button
            class="px-3 py-1 rounded text-sm cursor-pointer"
            [class.bg-blue-600]="settings.difficulty() === 'hard'"
            [class.bg-gray-700]="settings.difficulty() !== 'hard'"
            (click)="settings.setDifficulty('hard')"
          >
            Hard
          </button>
          <button
            class="px-3 py-1 rounded text-sm cursor-pointer"
            [class.bg-blue-600]="settings.difficulty() === 'nightmare'"
            [class.bg-gray-700]="settings.difficulty() !== 'nightmare'"
            (click)="settings.setDifficulty('nightmare')"
          >
            Nightmare
          </button>
        </div>
      </div>
      <div class="mb-3">
        <label class="text-sm mb-1 block">Map Size</label>
        <div class="flex gap-2">
          <button
            class="px-3 py-1 rounded text-sm cursor-pointer"
            [class.bg-indigo-600]="settings.mapSize() === 10"
            [class.bg-gray-700]="settings.mapSize() !== 10"
            (click)="onMapSizeChange(10)"
          >
            10x10
          </button>
          <button
            class="px-3 py-1 rounded text-sm cursor-pointer"
            [class.bg-indigo-600]="settings.mapSize() === 20"
            [class.bg-gray-700]="settings.mapSize() !== 20"
            (click)="onMapSizeChange(20)"
          >
            20x20
          </button>
          <button
            class="px-3 py-1 rounded text-sm cursor-pointer"
            [class.bg-indigo-600]="settings.mapSize() === 30"
            [class.bg-gray-700]="settings.mapSize() !== 30"
            (click)="onMapSizeChange(30)"
          >
            30x30
          </button>
        </div>
      </div>
    </div>
  }
  @if (gameEngine.highScoresOpen()) {
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-600 w-[680px] max-w-[95vw]">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-2xl font-bold">High Scores</h2>
          <button
            class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-700 hover:bg-gray-600 text-lg cursor-pointer"
            (click)="gameEngine.closeHighScores()"
          >
            ‚úñ
          </button>
        </div>
        <div class="text-sm text-gray-300 mb-2">
          Current: {{ settings.difficultyLabel() }} ‚Ä¢ {{ settings.mapSizeLabel() }}
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-gray-800/60 border border-gray-700 rounded-lg p-3">
            <h3 class="text-lg font-semibold mb-2 text-green-400">Player Wins (Top 3)</h3>
            @for (s of gameEngine.getHighScoresForCurrentCombo().wins; track s.date) {
              <div class="flex justify-between text-sm">
                <span>{{ s.date | date: 'yyyy-MM-dd HH:mm' }}</span>
                <span class="font-mono text-yellow-300">{{ s.turns }} turns</span>
              </div>
            } @empty {
              <div class="text-xs text-gray-400">No records yet</div>
            }
          </div>
          <div class="bg-gray-800/60 border border-gray-700 rounded-lg p-3">
            <h3 class="text-lg font-semibold mb-2 text-red-400">Player Losses (Top 3)</h3>
            @for (s of gameEngine.getHighScoresForCurrentCombo().losses; track s.date) {
              <div class="flex justify-between text-sm">
                <span>{{ s.date | date: 'yyyy-MM-dd HH:mm' }}</span>
                <span class="font-mono text-yellow-300">{{ s.turns }} turns</span>
              </div>
            } @empty {
              <div class="text-xs text-gray-400">No records yet</div>
            }
          </div>
        </div>
        <div class="mt-4 text-xs text-gray-400">Change Difficulty or Map Size in Settings to view other boards.</div>
      </div>
    </div>
  }
</div>
