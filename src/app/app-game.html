<div
  class="min-h-screen bg-gray-900 text-white flex flex-col items-center justify-start p-4 relative overflow-hidden"
>
  <!-- Floating Giants Background -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none select-none z-0">
    <div class="floating-shape shape-giant-1"></div>
    <div class="floating-shape shape-giant-2"></div>
    <div class="floating-shape shape-giant-3"></div>
    <div class="floating-shape shape-giant-4"></div>
    <div class="floating-shape shape-giant-5"></div>
  </div>

  <!-- SVG Defs for Soft Shapes -->
  <!-- <svg width="0" height="0" class="absolute pointer-events-none">
    <defs>
      <clipPath id="soft-triangle" clipPathUnits="objectBoundingBox">
        <path
          d="M0.5 0.05 Q0.5 0 0.56 0.12 L0.92 0.85 Q0.98 0.98 0.85 0.98 L0.15 0.98 Q0.02 0.98 0.08 0.85 L0.44 0.12 Q0.5 0 0.5 0.05"
        />
      </clipPath>
    </defs>
  </svg> -->
  <!-- Style for Units -->
  <svg style="position: absolute; width: 0; height: 0" aria-hidden="true">
    <defs>
      <radialGradient id="vol-fill-player" cx="35%" cy="30%" r="70%">
        <stop offset="0%" stop-color="#bfdbfe" />
        <stop offset="60%" stop-color="#3b82f6" />
        <stop offset="100%" stop-color="#2563eb" />
      </radialGradient>

      <radialGradient id="vol-fill-ai" cx="35%" cy="30%" r="70%">
        <stop offset="0%" stop-color="#fecaca" />
        <stop offset="60%" stop-color="#ef4444" />
        <stop offset="100%" stop-color="#dc2626" />
      </radialGradient>

      <radialGradient id="vol-fill-emerald" cx="35%" cy="30%" r="70%">
        <stop offset="0%" stop-color="#a7f3d0" />
        <stop offset="60%" stop-color="#10b981" />
        <stop offset="100%" stop-color="#059669" />
      </radialGradient>

      <linearGradient id="edge-light" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="white" stop-opacity="0.4" />
        <stop offset="100%" stop-color="white" stop-opacity="0" />
      </linearGradient>

      <filter id="soft-shadow" x="-20%" y="-20%" width="140%" height="140%">
        <feDropShadow dx="0" dy="2" stdDeviation="2.5" flood-color="#000" flood-opacity="0.4" />
      </filter>
    </defs>
  </svg>
  <!-- Style for Units END -->

  <svg width="0" height="0" class="absolute pointer-events-none">
    <defs>
      <clipPath id="soft-triangle" clipPathUnits="objectBoundingBox">
        <path
          d="M0.5 0.05 Q0.5 0 0.56 0.12 L0.92 0.85 Q0.98 0.98 0.85 0.98 L0.15 0.98 Q0.02 0.98 0.08 0.85 L0.44 0.12 Q0.5 0 0.5 0.05"
        />
      </clipPath>

      <symbol id="triangle-border" viewBox="0 0 1 1" preserveAspectRatio="none">
        <path
          d="M0.5 0.05 Q0.5 0 0.56 0.12 L0.92 0.85 Q0.98 0.98 0.85 0.98 L0.15 0.98 Q0.02 0.98 0.08 0.85 L0.44 0.12 Q0.5 0 0.5 0.05"
          fill="none"
          stroke="rgba(255,255,255,0.3)"
          stroke-width="2"
          vector-effect="non-scaling-stroke"
        />
      </symbol>
    </defs>
  </svg>

  <!-- Title -->
  <div class="fixed top-8 left-8 flex items-start gap-4 group select-none mobile-hide-logo">
    <button (click)="goToHub()" class="cursor-pointer p-2 bg-slate-800/50 hover:bg-slate-700 border border-slate-700/50 rounded-lg transition-all group/btn" title="Return to Gaming Hub">
      <svg class="w-6 h-6 text-slate-400 group-hover/btn:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
      </svg>
    </button>
    <div class="relative w-12 h-12 flex items-center justify-center">
      <div
        class="absolute inset-0 border-2 border-blue-500/30 rotate-45 group-hover:rotate-90 transition-all duration-700"
      ></div>
      <div
        class="absolute inset-1 border border-blue-400/20 -rotate-45 group-hover:rotate-0 transition-all duration-1000"
      ></div>

      <svg viewBox="0 0 24 24" class="w-6 h-6 text-white drop-shadow-[0_0_8px_rgba(59,130,246,0.8)]">
        <path fill="currentColor" d="M12 2L2 22h20L12 2zm0 4.5L18.5 20h-13L12 6.5z" />
        <rect x="11" y="12" width="2" height="5" fill="white" class="animate-pulse" />
      </svg>

      <div class="absolute -top-1 -left-1 w-2 h-2 border-t-2 border-l-2 border-blue-400"></div>
      <div class="absolute -bottom-1 -right-1 w-2 h-2 border-b-2 border-r-2 border-blue-400"></div>
    </div>

    <div class="flex flex-col">
      <div class="flex items-baseline gap-1">
        <h1 class="text-3xl font-black tracking-tight uppercase leading-none flex flex-col">
          <span class="text-white drop-shadow-[0_0_5px_rgba(255,255,255,0.2)]">Shape</span>
          <span
            class="text-blue-500 text-xl mt-[-4px] tracking-[0.15em] opacity-90 group-hover:text-blue-400 transition-colors"
          >
            Tactics
          </span>
        </h1>
        <div class="flex gap-1 mb-1">
          <div class="w-1 h-3 bg-blue-600/40"></div>
          <div class="w-1 h-3 bg-blue-600/20"></div>
        </div>
      </div>
      <div class="flex items-center ml-1">
        <span class="text-[10px] font-mono text-blue-300 font-bold leading-none">{{ settings.version }}</span>
      </div>
    </div>

    <div
      class="absolute -inset-4 bg-blue-600/5 opacity-0 group-hover:opacity-50 transition-opacity blur-2xl -z-10"
    ></div>
  </div>
  <!-- Title END -->
  <!-- Navigation -->
  <div
    class="nav-bar w-full max-w-5xl flex items-center justify-between mb-2 px-4 py-1 rounded-full bg-white/[0.03] backdrop-blur-md border border-white/5 shadow-2xl"
  >
    <div class="flex items-center gap-1">
      <button
        (click)="gameEngine.resetGame()"
        class="cursor-pointer group flex items-center gap-2 px-4 py-2 rounded-full hover:bg-blue-500/10 transition-all duration-300"
      >
        <svg
          class="w-3.5 h-3.5 text-stone-400 group-hover:text-blue-400 group-hover:rotate-180 transition-all duration-500"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
          ></path>
        </svg>
        <span
          class="text-[10px] font-black uppercase tracking-widest text-stone-400 group-hover:text-blue-300 transition-colors"
        >
          {{ settings.t('RELOAD') }}
        </span>
      </button>

      <div class="w-[1px] h-4 bg-white/10 mx-1"></div>

      <button
        (click)="gameEngine.toggleRules()"
        class="cursor-pointer group flex items-center gap-2 px-4 py-2 rounded-full hover:bg-white/5 transition-all"
      >
        <svg
          class="w-3.5 h-3.5 text-stone-400 group-hover:text-white transition-colors"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
        <span class="text-[10px] font-black uppercase tracking-widest text-stone-400 group-hover:text-white">
          {{ settings.t('INFO') }}
        </span>
      </button>
    </div>

    <div class="flex items-center bg-black/20 rounded-full px-2 py-1 border border-white/5 shadow-inner">
      <button
        (click)="gameEngine.toggleHighScores()"
        class="cursor-pointer flex items-center gap-2 px-4 py-1.5 rounded-full hover:bg-white/5 text-stone-400 hover:text-yellow-400 transition-all group"
      >
        <svg
          class="w-3.5 h-3.5 opacity-50 group-hover:opacity-100"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"
          ></path>
        </svg>
        <span class="text-[10px] font-bold uppercase tracking-tighter">{{ settings.t('RECORDS') }}</span>
      </button>

      <button
        (click)="gameEngine.toggleLeaderboard()"
        class="cursor-pointer flex items-center gap-2 px-4 py-1.5 rounded-full hover:bg-white/5 text-stone-400 hover:text-indigo-400 transition-all group"
      >
        <svg
          class="w-3.5 h-3.5 opacity-50 group-hover:opacity-100"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
          ></path>
        </svg>
        <span class="text-[10px] font-bold uppercase tracking-tighter">{{ settings.t('RANKING') }}</span>
      </button>

      <button
        (click)="gameEngine.toggleLog()"
        class="cursor-pointer flex items-center gap-2 px-4 py-1.5 rounded-full hover:bg-white/5 text-stone-400 hover:text-red-400 transition-all group"
      >
        <svg
          class="w-3.5 h-3.5 opacity-50 group-hover:opacity-100"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          ></path>
        </svg>
        <span class="text-[10px] font-bold uppercase tracking-tighter">{{ settings.t('SYSTEM_LOG') }}</span>
      </button>
      <button
        (click)="navigateToFeedback()"
        class="cursor-pointer flex items-center gap-2 px-4 py-1.5 rounded-full hover:bg-white/5 text-stone-400 hover:text-indigo-300 transition-all group"
      >
        <svg
          class="w-3.5 h-3.5 opacity-50 group-hover:opacity-100"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M17 8h2a2 2 0 012 2v9l-4-4H7a2 2 0 01-2-2V6a2 2 0 012-2h8"
          ></path>
        </svg>
        <span class="text-[10px] font-bold uppercase tracking-tighter">{{ settings.t('FEEDBACK_MODULE') }}</span>
      </button>
    </div>

    <div class="flex items-center gap-3">
      <button
        (click)="gameEngine.toggleSettings()"
        class="cursor-pointer w-8 h-8 flex items-center justify-center rounded-full bg-white/5 border border-white/10 hover:bg-blue-500/20 transition-all group"
      >
        <svg
          class="w-4 h-4 text-stone-400 group-hover:text-blue-400 group-hover:rotate-90 transition-all duration-500"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
          ></path>
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
          ></path>
        </svg>
      </button>

      @if (firebase.user$(); as user) {
        <div class="flex items-center gap-3 pl-3 pr-1 py-1 rounded-full bg-white/5 border border-white/10 shadow-inner">
          <div class="flex flex-col items-end leading-none">
            <span class="text-[9px] font-black text-blue-400 uppercase tracking-tighter mb-0.5">
              {{ settings.t('VERIFIED') }}
            </span>
            <button
              (click)="firebase.logout()"
              class="cursor-pointer text-[9px] text-stone-500 hover:text-red-400 uppercase font-bold tracking-widest transition-colors"
            >
              {{ settings.t('LOGOUT') }}
            </button>
          </div>

          <div class="relative">
            <img
              [src]="user.photoURL"
              class="w-8 h-8 rounded-full border border-blue-500/30 shadow-[0_0_10px_rgba(59,130,246,0.3)]"
              referrerpolicy="no-referrer"
            />
            <div
              class="absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 bg-green-500 border-2 border-gray-900 rounded-full"
            ></div>
          </div>
        </div>
      } @else {
        <button
          (click)="firebase.loginWithGoogle()"
          class="cursor-pointer flex items-center gap-2 px-4 py-1.5 rounded-full bg-blue-600/10 border border-blue-500/20 hover:bg-blue-600/30 transition-all group"
        >
          <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-pulse"></div>
          <span class="text-[9px] font-black uppercase tracking-widest text-blue-200">
            {{ settings.t('CONNECT') }}
          </span>
        </button>
      }
    </div>
  </div>
  <!-- Navigation END -->
  <!-- MOBILE Navigation -->
  <div
    class="mobile-hud-header w-full max-w-5xl px-3 py-2 flex items-center justify-between gap-3 rounded-xl bg-gray-900/60 border border-white/10 backdrop-blur-md"
  >
    <div class="hud-item flex items-center gap-2">
      <svg width="20" height="20" viewBox="0 0 24 24">
        <rect x="7" y="14" width="13" height="6" rx="3" fill="#8B5E3C" />
        <circle cx="7" cy="17" r="3" fill="#A67B5B" />
      </svg>
      <span class="hud-value font-mono text-sm font-bold text-emerald-400">{{ gameEngine.resources().wood }}</span>
    </div>
    <div class="hud-item flex items-center gap-2">
      <svg width="20" height="20" viewBox="0 0 24 24">
        <path d="M6 18 L10 12 L14 18 Z" fill="#9ca3af" />
        <circle cx="12" cy="10" r="3" fill="#6b7280" />
      </svg>
      <span class="hud-value font-mono text-sm font-bold text-slate-300">{{ gameEngine.resources().iron }}</span>
    </div>
    <div class="hud-item flex items-center gap-2">
      <svg width="20" height="20" viewBox="0 0 24 24">
        <polygon points="12,3 6,13 9,13 4,21 20,21 15,13 18,13" fill="#6fbf73" />
      </svg>
      <span class="hud-value font-mono text-sm font-bold text-blue-300">
        {{ gameEngine.getForestControl().player }}/{{ gameEngine.getForestControl().total }}
      </span>
    </div>
    <div class="hud-item flex items-center gap-2">
      <svg width="20" height="20" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="9" stroke="#d1b54a" fill="none" />
        <path d="M12 7 L12 12 L16 14" stroke="#d1b54a" stroke-width="2" />
      </svg>
      <span class="hud-value font-mono text-sm font-bold text-yellow-300">{{ gameEngine.turn() }}</span>
    </div>
    <div class="hud-item flex items-center gap-2">
      <svg width="20" height="20" viewBox="0 0 24 24">
        <path d="M4 20 L20 20" stroke="#999" />
        <rect x="6" y="8" width="4" height="8" fill="#3b82f6" />
        <rect x="14" y="6" width="4" height="10" fill="#ef4444" />
      </svg>
      <span class="hud-value font-mono text-sm font-bold text-white">
        {{ gameEngine.getForestControl().player }} : {{ gameEngine.getForestControl().ai }}
      </span>
    </div>
    <button
      class="burger-btn w-9 h-9 rounded-md bg-white/10 border border-white/20 flex items-center justify-center text-white"
      (click)="toggleMobileMenu()"
    >
      <svg width="18" height="18" viewBox="0 0 24 24">
        <path d="M4 6h16M4 12h16M4 18h16" stroke="#fff" stroke-width="2" />
      </svg>
    </button>
  </div>
  <!-- GAME Mobile actions -->
  <div class="actions-bar w-full max-w-5xl px-3 py-2 flex items-center justify-center gap-4">
    <button class="action-btn" [disabled]="!gameEngine.canBuildThisTurn()" (click)="gameEngine.toggleBuildMode()">
      <svg width="20" height="20" viewBox="0 0 24 24">
        <path d="M3 21 L9 15 L5 11 L11 5 L13 7 L17 3 L21 7 L17 11 L19 13 L13 19 Z" fill="#e5e7eb" />
      </svg>
    </button>
    <button class="action-btn" [disabled]="!gameEngine.canAddReserveTurn()" (click)="gameEngine.convertWoodToReserve()">
      +1
    </button>
    <button
      class="action-btn"
      [disabled]="!gameEngine.canAddReserveTurn()"
      (click)="gameEngine.maxConvertWoodToReserve()"
    >
      {{ settings.t('ALL') }}
    </button>
    <label
      class="flex items-center gap-1 rounded-lg hover:bg-white/5 transition-colors cursor-pointer border border-transparent hover:border-white/5"
    >
      <div class="relative flex items-center">
        <input
          type="checkbox"
          class="peer h-4 w-4 opacity-0 absolute"
          [checked]="gameEngine.fogDebugDisabled()"
          (change)="gameEngine.toggleFogDebug()"
        />
        <div
          class="h-4 w-4 border-2 border-gray-500 rounded flex items-center justify-center peer-checked:bg-blue-500 peer-checked:border-blue-500 transition-all"
        >
          <div class="h-2 w-2 bg-white rounded-full opacity-0 peer-checked:opacity-100"></div>
        </div>
      </div>
      <span class="text-[10px] uppercase tracking-widest text-gray-400 font-bold">{{ settings.t('MAP_HACK') }}</span>
    </label>
    <div class="mt-1 text-[10px] uppercase tracking-widest font-bold text-gray-300">
      {{ gameEngine.remainingActions() }}/{{ gameEngine.totalPlayerUnits() }}
    </div>
    <button (click)="gameEngine.endPlayerTurn()" class="action-btn">
      <svg
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2.5"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M5 12h14"></path>
        <path d="m12 5 7 7-7 7"></path>
      </svg>
    </button>
  </div>
  <!-- GAME Mobile actions EnD-->
  @if (isMobileMenuOpen()) {
    <div class="mobile-menu-overlay fixed inset-0 bg-black/70 z-50 flex items-start justify-end">
      <div class="mobile-menu-panel w-72 h-full bg-gray-800 border-l border-white/10 p-4 flex flex-col gap-3">
        <button
          class="w-9 h-9 rounded-md bg-white/10 border border-white/20 flex items-center justify-center text-white self-end"
          (click)="closeMobileMenu()"
        >
          <svg width="18" height="18" viewBox="0 0 24 24">
            <path d="M6 6l12 12M18 6L6 18" stroke="#fff" stroke-width="2" />
          </svg>
        </button>
        <button class="menu-link" (click)="gameEngine.resetGame()">{{ settings.t('RELOAD') }}</button>
        <button class="menu-link" (click)="gameEngine.toggleRules()">{{ settings.t('INFO') }}</button>
        <button class="menu-link" (click)="gameEngine.toggleLeaderboard()">{{ settings.t('RANKING') }}</button>
        <button class="menu-link" (click)="gameEngine.toggleLog()">{{ settings.t('SYSTEM_LOG') }}</button>
        <button class="menu-link" (click)="navigateToFeedback()">{{ settings.t('FEEDBACK_MODULE') }}</button>
        <button class="menu-link" (click)="navigateToRoadmap()">{{ settings.t('STRATEGIC_PLAN') }}</button>
        <button class="menu-link" (click)="gameEngine.toggleSettings()">{{ settings.t('SETTINGS') }}</button>
        <button class="menu-link" (click)="navigateToRoadmap()">{{ settings.t('STRATEGIC_PLAN') }}</button>
        @if (firebase.user$(); as user) {
          <div
            class="flex items-center gap-3 pl-3 pr-1 py-1 rounded-full bg-white/5 border border-white/10 shadow-inner"
          >
            <div class="flex flex-col items-end leading-none">
              <span class="text-[9px] font-black text-blue-400 uppercase tracking-tighter mb-0.5">
                {{ settings.t('VERIFIED') }}
              </span>
              <button
                (click)="firebase.logout()"
                class="cursor-pointer text-[9px] text-stone-500 hover:text-red-400 uppercase font-bold tracking-widest transition-colors"
              >
                {{ settings.t('LOGOUT') }}
              </button>
            </div>

            <div class="relative">
              <img
                [src]="user.photoURL"
                class="w-8 h-8 rounded-full border border-blue-500/30 shadow-[0_0_10px_rgba(59,130,246,0.3)]"
                referrerpolicy="no-referrer"
              />
              <div
                class="absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 bg-green-500 border-2 border-gray-900 rounded-full"
              ></div>
            </div>
          </div>
          <button
            (click)="toggleAutoBattle()"
            class="cursor-pointer group relative px-4 py-3 rounded-xl text-sm font-bold transition-all duration-200 flex items-center justify-between gap-3 overflow-hidden border border-green-400/30 bg-gradient-to-br from-green-600/20 to-green-800/40 hover:from-green-500/40 hover:to-green-700/60 shadow-[0_0_15px_rgba(34,197,94,0.2)] active:scale-95 disabled:opacity-40 disabled:grayscale disabled:cursor-not-allowed"
            [class.ring-2]="isAutoBattleActive()"
            [class.ring-green-400]="isAutoBattleActive()"
            [disabled]="gameEngine.gameStatus() !== 'playing'"
          >
            <div class="flex items-center gap-2 z-10">
              <span class="text-green-200 text-xs tracking-widest uppercase">{{ settings.t('AUTO') }}</span>
              <span class="text-white">{{ settings.t('ENGAGE') }}</span>
            </div>
            <div class="flex items-center gap-2 z-10">
              <span
                class="h-2 w-2 rounded-full"
                [class.bg-green-400]="isAutoBattleActive()"
                [class.bg-gray-500]="!isAutoBattleActive()"
              ></span>
            </div>
            <div
              class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite] pointer-events-none"
            ></div>
          </button>
        } @else {
          <button
            (click)="firebase.loginWithGoogle()"
            class="cursor-pointer flex items-center gap-2 px-4 py-1.5 rounded-full bg-blue-600/10 border border-blue-500/20 hover:bg-blue-600/30 transition-all group"
          >
            <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-pulse"></div>
            <span class="text-[9px] font-black uppercase tracking-widest text-blue-200">
              {{ settings.t('CONNECT') }}
            </span>
          </button>
        }
      </div>
    </div>
  }
  <!-- MOBILE Navigation END -->
  <!-- Battle Status Bar -->
  <div
    class="status-bar w-full max-w-6xl flex items-center justify-between mb-8 px-6 py-3 rounded-2xl bg-gray-900/40 backdrop-blur-xl border border-white/10 shadow-[0_10px_30px_rgba(0,0,0,0.5)] relative overflow-hidden"
  >
    <div
      class="absolute bottom-0 left-0 h-[1px] bg-gradient-to-r from-transparent via-blue-500/50 to-transparent w-full"
    ></div>

    <div class="flex items-center gap-6">
      <div class="flex flex-col items-start">
        <span class="text-[10px] uppercase tracking-widest text-blue-400 font-black mb-1">
          {{ settings.t('COMMANDER') }}
        </span>
        <span class="text-xl font-black text-white drop-shadow-[0_0_8px_rgba(59,130,246,0.5)]">
          {{ settings.t('PLAYER') }}
        </span>
      </div>

      <div class="h-10 w-[1px] bg-white/5"></div>

      <div class="flex gap-4">
        <div
          class="flex items-center gap-2 px-3 py-1.5 rounded-xl bg-white/5 border border-white/5 shadow-inner"
          [attr.title]="settings.currentLang() === 'uk' ? '–ó—ñ–±—Ä–∞–Ω–æ—ó –î–µ—Ä–µ–≤–∏–Ω–∏' : 'Harvested Wood'"
        >
          <span class="text-lg">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="7" y="14" width="13" height="6" rx="3" fill="#8B5E3C" />
              <circle cx="7" cy="17" r="3" fill="#A67B5B" stroke="#724A2D" stroke-width="1" />
              <circle cx="7" cy="17" r="1.5" stroke="#724A2D" stroke-width="0.5" />

              <rect x="7" y="5" width="13" height="6" rx="3" fill="#A67B5B" />
              <circle cx="7" cy="8" r="3" fill="#C49A6C" stroke="#8B5E3C" stroke-width="1" />
              <circle cx="7" cy="8" r="1.5" stroke="#8B5E3C" stroke-width="0.5" />
            </svg>
          </span>
          <span class="font-mono text-lg font-bold text-emerald-400">{{ gameEngine.resources().wood }}</span>
        </div>
        <div
          class="flex items-center gap-2 px-3 py-1.5 rounded-xl bg-white/5 border border-white/5 shadow-inner"
          [attr.title]="settings.currentLang() === 'uk' ? '–ó—ñ–±—Ä–∞–Ω–æ–≥–æ –ó–∞–ª—ñ–∑–∞' : 'Harvested Iron'"
        >
          <span class="text-lg">
            <svg width="24" height="24" viewBox="0 0 24 24">
              <path d="M6 18 L10 12 L14 18 Z" fill="#9ca3af" />
              <circle cx="12" cy="10" r="3" fill="#6b7280" />
            </svg>
          </span>
          <span class="font-mono text-lg font-bold text-slate-300">{{ gameEngine.resources().iron }}</span>
        </div>
        <div
          class="flex items-center gap-2 px-3 py-1.5 rounded-xl bg-blue-500/10 border border-blue-500/20 shadow-inner"
          [attr.title]="settings.currentLang() === 'uk' ? '–ú–æ–Ω–æ–ø–æ–ª—ñ—è –õ—ñ—Å—ñ–≤' : 'Monopoly of Forests'"
        >
          <span class="text-lg">
            <div class="w-8 h-8 flex-shrink-0">
              <svg viewBox="0 0 64 64" class="w-full h-full" xmlns="http://www.w3.org/2000/svg">
                <!-- Back tree (left) -->
                <polygon
                  points="14,18 6,32 10,32 2,48 22,48 14,32 18,32"
                  fill="#3f8f5c"
                  stroke="#2e6b4c"
                  stroke-width="2"
                  stroke-linejoin="round"
                  opacity="0.7"
                />
                <rect x="11" y="48" width="4.5" height="6" fill="#4f9f68" stroke="#2e6b4c" stroke-width="1.2" />

                <!-- Main tree (center) -->
                <polygon
                  points="34,10 20,28 26,28 14,50 46,50 34,28 40,28"
                  fill="#6fbf73"
                  stroke="#2e6b4c"
                  stroke-width="2"
                  stroke-linejoin="round"
                  opacity="0.85"
                />
                <rect x="31" y="50" width="6" height="6" fill="#4f9f68" stroke="#2e6b4c" stroke-width="1.5" />

                <!-- Right tree -->
                <polygon
                  points="48,16 36,32 42,32 32,50 60,50 50,32 56,32"
                  fill="#5fae7a"
                  stroke="#2e6b4c"
                  stroke-width="2"
                  stroke-linejoin="round"
                  opacity="0.75"
                />
                <rect x="45" y="50" width="5" height="6" fill="#4f9f68" stroke="#2e6b4c" stroke-width="1.2" />

                <!-- FLAG (team color) -->
                <g transform="translate(-14,-1) scale(1.4)">
                  <rect x="28.5" y="18" width="3" height="20" fill="#71411e" />
                  <polygon points="31,18 52,22 31,26" fill="#0800ff" />
                </g>
                <!-- wOOD -->
                <g transform="translate(10,52) scale(0.3)">
                  <rect x="0" y="0" width="68" height="14" rx="7" fill="#d89b5a" stroke="#5a3418" stroke-width="2" />
                  <circle cx="10" cy="7" r="3" fill="#5a3418" />
                  <circle cx="58" cy="7" r="3" fill="#5a3418" />
                </g>
              </svg>
            </div>
          </span>
          <span class="font-mono text-lg font-bold text-blue-300">
            {{ gameEngine.getForestControl().player }}
            <span class="text-xs text-white/30 mx-1">/</span>
            {{ gameEngine.getForestControl().total }}
          </span>
        </div>
      </div>
    </div>

    <div class="flex flex-col items-center justify-center px-8 relative">
      <div class="absolute inset-0 bg-yellow-500/5 blur-2xl rounded-full"></div>
      <span class="text-[10px] uppercase tracking-[0.3em] text-stone-500 font-bold">
        {{ settings.t('TURN_CYCLE') }}
      </span>
      <div class="flex items-baseline gap-1">
        <span class="text-3xl font-black text-yellow-400 drop-shadow-[0_0_15px_rgba(250,204,21,0.4)]">
          {{ gameEngine.turn() }}
        </span>
      </div>

      @if (gameEngine.monopolyTurnsLeft() > 0) {
        <div
          class="absolute monopoly-top whitespace-nowrap px-4 py-1 rounded-full bg-emerald-500/20 border border-emerald-500/30 text-[10px] font-black uppercase tracking-widest text-emerald-300 animate-pulse"
        >
          {{ settings.t('MONOPOLY') }} {{ gameEngine.monopolyTurnsLeft() }} {{ settings.t('LFT') }}
        </div>
      }
    </div>

    <div class="flex items-center gap-6">
      <div class="flex gap-4">
        <div
          class="flex items-center gap-2 px-3 py-1.5 rounded-xl bg-white/5 border border-white/5 shadow-inner"
          [attr.title]="settings.currentLang() === 'uk' ? '–ó—ñ–±—Ä–∞–Ω–æ—ó –î–µ—Ä–µ–≤–∏–Ω–∏' : 'Harvested Wood'"
        >
          <span class="font-mono text-lg font-bold text-red-400">{{ gameEngine.aiWood() }}</span>
          <span class="text-lg">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="7" y="14" width="13" height="6" rx="3" fill="#8B5E3C" />
              <circle cx="7" cy="17" r="3" fill="#A67B5B" stroke="#724A2D" stroke-width="1" />
              <circle cx="7" cy="17" r="1.5" stroke="#724A2D" stroke-width="0.5" />

              <rect x="7" y="5" width="13" height="6" rx="3" fill="#A67B5B" />
              <circle cx="7" cy="8" r="3" fill="#C49A6C" stroke="#8B5E3C" stroke-width="1" />
              <circle cx="7" cy="8" r="1.5" stroke="#8B5E3C" stroke-width="0.5" />
            </svg>
          </span>
        </div>
        <div
          class="flex items-center gap-2 px-3 py-1.5 rounded-xl bg-white/5 border border-white/5 shadow-inner"
          [attr.title]="settings.currentLang() === 'uk' ? '–ó—ñ–±—Ä–∞–Ω–æ–≥–æ –ó–∞–ª—ñ–∑–∞' : 'Harvested Iron'"
        >
          <span class="text-lg">
            <svg width="24" height="24" viewBox="0 0 24 24">
              <path d="M6 18 L10 12 L14 18 Z" fill="#9ca3af" />
              <circle cx="12" cy="10" r="3" fill="#6b7280" />
            </svg>
          </span>
          <span class="font-mono text-lg font-bold text-slate-300">{{ gameEngine.aiIron() }}</span>
        </div>
        <div
          class="flex items-center gap-2 px-3 py-1.5 rounded-xl bg-red-500/10 border border-red-500/20 shadow-inner"
          [attr.title]="settings.currentLang() === 'uk' ? '–ú–æ–Ω–æ–ø–æ–ª—ñ—è –õ—ñ—Å—ñ–≤' : 'Monopoly of Forests'"
        >
          <span class="font-mono text-lg font-bold text-red-300">
            {{ gameEngine.getForestControl().ai }}
            <span class="text-xs text-white/30 mx-1">/</span>
            {{ gameEngine.getForestControl().total }}
          </span>
          <span class="text-lg">
            <div class="w-8 h-8 flex-shrink-0">
              <svg viewBox="0 0 64 64" class="w-full h-full" xmlns="http://www.w3.org/2000/svg">
                <!-- Back tree (left) -->
                <polygon
                  points="14,18 6,32 10,32 2,48 22,48 14,32 18,32"
                  fill="#3f8f5c"
                  stroke="#2e6b4c"
                  stroke-width="2"
                  stroke-linejoin="round"
                  opacity="0.7"
                />
                <rect x="11" y="48" width="4.5" height="6" fill="#4f9f68" stroke="#2e6b4c" stroke-width="1.2" />

                <!-- Main tree (center) -->
                <polygon
                  points="34,10 20,28 26,28 14,50 46,50 34,28 40,28"
                  fill="#6fbf73"
                  stroke="#2e6b4c"
                  stroke-width="2"
                  stroke-linejoin="round"
                  opacity="0.85"
                />
                <rect x="31" y="50" width="6" height="6" fill="#4f9f68" stroke="#2e6b4c" stroke-width="1.5" />

                <!-- Right tree -->
                <polygon
                  points="48,16 36,32 42,32 32,50 60,50 50,32 56,32"
                  fill="#5fae7a"
                  stroke="#2e6b4c"
                  stroke-width="2"
                  stroke-linejoin="round"
                  opacity="0.75"
                />
                <rect x="45" y="50" width="5" height="6" fill="#4f9f68" stroke="#2e6b4c" stroke-width="1.2" />

                <!-- FLAG (team color) -->
                <g transform="translate(-14,-1) scale(1.4)">
                  <rect x="28.5" y="18" width="3" height="20" fill="#71411e" />
                  <polygon points="31,18 52,22 31,26" fill="#ef4444" />
                </g>
                <!-- wOOD -->
                <g transform="translate(10,52) scale(0.3)">
                  <rect x="0" y="0" width="68" height="14" rx="7" fill="#d89b5a" stroke="#5a3418" stroke-width="2" />
                  <circle cx="10" cy="7" r="3" fill="#5a3418" />
                  <circle cx="58" cy="7" r="3" fill="#5a3418" />
                </g>
              </svg>
            </div>
          </span>
        </div>
      </div>

      <div class="h-10 w-[1px] bg-white/5"></div>

      <div class="flex flex-col items-end">
        <span class="text-[10px] uppercase tracking-widest text-red-400 font-black mb-1">
          {{ settings.t('HOSTILE') }}
        </span>
        <span class="text-xl font-black text-white drop-shadow-[0_0_8px_rgba(239,68,68,0.5)]">jaerbi</span>
      </div>
    </div>
  </div>
  <!-- Battle Status Bar END -->

  <!-- END MODAL -->
  @if (gameEngine.shouldShowEndOverlay()) {
    <div class="end-overlay fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="end-dialog bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-600 text-center">
        <h2
          class="text-4xl font-bold mb-4"
          [class.text-blue-400]="gameEngine.gameStatus() === 'player wins'"
          [class.text-red-500]="gameEngine.gameStatus() === 'jaerbi wins'"
        >
          {{ gameEngine.gameStatus() | titlecase }}!
        </h2>
        @if (gameEngine.endReason()) {
          <div class="text-sm text-gray-300 mb-4">{{ gameEngine.endReason() }}</div>
        }
        @if (gameEngine.gameStatus() === 'player wins' && gameEngine.isNamePromptOpen()) {
          <div class="mb-4 flex flex-col items-center gap-2">
            <div class="text-sm text-gray-300">{{ settings.t('CONFIRM_NAME') }}</div>
            <input
              #nameInput
              [value]="gameEngine.getPlayerName()"
              class="w-64 px-3 py-2 rounded bg-gray-700 border border-gray-600 text-white"
              placeholder="Enter your name"
              autocomplete="off"
            />
            <button
              (click)="gameEngine.confirmAndSaveScore(nameInput.value)"
              class="px-4 py-2 bg-yellow-600 hover:bg-yellow-500 rounded text-white font-semibold text-sm cursor-pointer"
            >
              {{ settings.t('SAVE_SCORE') }}
            </button>
          </div>
        }
        <button
          (click)="gameEngine.resetGame()"
          class="px-6 py-3 bg-green-600 hover:bg-green-500 rounded text-white font-bold text-lg cursor-pointer"
        >
          {{ settings.t('PLAY_AGAIN') }}
        </button>
      </div>
      <button
        (click)="gameEngine.toggleLeaderboard()"
        class="ml-3 px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded text-white font-bold text-lg cursor-pointer"
      >
        {{ settings.t('VIEW_LEADERBOARD') }}
      </button>
    </div>
  }
  <!-- END MODAL END -->
  <!-- SUPPORT BTN -->
  <button
    (click)="navigateToRoadmap()"
    class="mobile-actions-compact roadmap mobile-actions-compact-plan fixed bottom-20 right-6 z-50 flex items-center group cursor-pointer outline-none translate-x-2 hover:translate-x-0 transition-transform duration-300"
  >
    <div
      class="h-10 mobile-actions-hide-text px-4 bg-blue-600/20 border-y border-l border-blue-500/50 backdrop-blur-md flex items-center gap-3 group-hover:bg-blue-600/40 transition-all"
    >
      <div class="w-1.5 h-1.5 bg-blue-400 rotate-45 animate-pulse"></div>
      <span
        class="text-[11px] font-black uppercase tracking-[0.3em] text-blue-100 drop-shadow-[0_0_8px_rgba(255,255,255,0.5)]"
      >
        {{ settings.t('STRATEGIC_PLAN') }}
      </span>
    </div>

    <div
      class="h-10 w-10 bg-blue-600/30 border border-blue-500/50 flex items-center justify-center group-hover:bg-blue-600 transition-all shadow-[0_0_15px_rgba(37,99,235,0.2)]"
    >
      <svg
        class="w-4 h-4 text-white group-hover:scale-125 transition-transform"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
      </svg>
    </div>
  </button>
  <button
    class="mobile-actions-compact fixed bottom-4 right-4 z-50 px-4 py-2 rounded-full bg-pink-600 hover:bg-pink-500 text-white shadow-xl cursor-pointer flex items-center gap-2 support-pulse"
    (click)="gameEngine.toggleSupport()"
    aria-label="Support the Project"
  >
    <span class="text-lg">‚ù§Ô∏è</span>
    <span class="text-lg mb-[2px] mobile-actions-hide-text">{{ settings.t('SUPPORT') }}</span>
  </button>
  <!-- SUPPORT BUTTON END -->

  @if (gameEngine.supportOpen()) {
    <app-support-community />
  }
  @if (gameEngine.leaderboardOpen()) {
    <app-leaderboard-modal />
  }

  <style>
    * {
      box-sizing: border-box;
    }
    .tile {
      min-width: 64px;
      min-height: 64px;
      aspect-ratio: 1 / 1;
      position: relative;
    }
    .combat-text-anim {
      animation: combatFloat 0.5s ease-out;
    }
    @keyframes combatFloat {
      from {
        transform: translateY(0);
      }
      to {
        transform: translateY(-12px);
      }
    }
    .shake {
      animation: defenderShake 200ms ease-out;
    }
    @keyframes defenderShake {
      0% {
        transform: translate(0, 0);
      }
      25% {
        transform: translate(2px, -2px);
      }
      50% {
        transform: translate(-2px, 2px);
      }
      75% {
        transform: translate(2px, 2px);
      }
      100% {
        transform: translate(0, 0);
      }
    }
    .arrival-pop {
      animation: arrivalPop 200ms ease-out;
    }
    @keyframes arrivalPop {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
      100% {
        transform: scale(1);
      }
    }
    .pulse-glow {
      animation: pulseGlow 400ms ease-out;
    }
    @keyframes pulseGlow {
      0% {
        box-shadow: 0 0 0px rgba(255, 215, 0, 0);
      }
      50% {
        box-shadow: 0 0 12px rgba(255, 215, 0, 0.8);
      }
      100% {
        box-shadow: 0 0 0px rgba(255, 215, 0, 0);
      }
    }
    .wood-pulse-icon {
      animation: woodPulse 1000ms ease-in-out infinite;
      filter: drop-shadow(0 0 4px rgba(16, 185, 129, 0.7));
    }
    @keyframes woodPulse {
      0% {
        transform: scale(0.9);
        opacity: 0.6;
      }
      50% {
        transform: scale(1.1);
        opacity: 1;
      }
      100% {
        transform: scale(0.9);
        opacity: 0.6;
      }
    }
    .move-anim {
      transition: transform 150ms cubic-bezier(0.4, 0, 0.2, 1);
      will-change: transform;
    }
  </style>

  <div class="relative z-10">
    @if (settings.customMode()) {
      <app-sandbox />
    }
    <div
      #boardContainer
      [class.shake]="gameEngine.screenShake()"
      [class.mood-none]="gameEngine.currentMood() === 'none'"
      [class.mood-angry]="gameEngine.currentMood() === 'angry'"
      [class.mood-rage]="gameEngine.currentMood() === 'rage'"
      class="board max-w-[90vw] max-h-[90vh] overflow-auto bg-gray-800 p-2 rounded-lg border border-gray-700 select-none relative mx-auto my-auto no-select"
    >
      <div
        class="grid"
        [style.gridTemplateColumns]="
          'repeat(' +
          gameEngine.gridSize +
          ', minmax(' +
          gameEngine.tileMinSizePx +
          'px, ' +
          gameEngine.tileSizePx +
          'px))'
        "
        [style.gap.px]="gameEngine.wallThicknessPx + 2"
      >
        <!-- Base Indicators -->
        <div
          class="absolute top-2 left-2 w-12 h-12 border-2 border-blue-500/30 rounded pointer-events-none flex items-center justify-center"
        >
          <span class="text-white font-bold bg-blue-600 px-1 rounded shadow text-xs">
            {{ gameEngine.baseHealth().player }}
          </span>
        </div>
        @if (gameEngine.isVisibleToPlayer(gameEngine.gridSize - 1, gameEngine.gridSize - 1)) {
          <div
            class="absolute bottom-2 right-2 w-12 h-12 border-2 border-red-500/30 rounded pointer-events-none flex items-center justify-center"
          >
            <span class="text-white font-bold bg-red-600 px-1 rounded shadow text-xs">
              {{ gameEngine.baseHealth().ai }}
            </span>
          </div>
        }

        @for (y of gameEngine.gridRows; track y) {
          @for (x of gameEngine.gridCols; track x) {
            <div
              (click)="onTileClick(x, y)"
              (mouseenter)="
                gameEngine.setHoveredUnit(
                  gameEngine.getUnitAt(x, y) &&
                    (gameEngine.getUnitAt(x, y)!.owner === 'player' || gameEngine.isVisibleToPlayer(x, y))
                    ? gameEngine.getUnitAt(x, y)!.id
                    : null
                )
              "
              (mouseleave)="gameEngine.setHoveredUnit(null)"
              class="tile rounded flex items-center justify-center border transition-colors duration-200"
              [style.width.px]="gameEngine.tileSizePx"
              [style.height.px]="gameEngine.tileSizePx"
              [style.minWidth.px]="gameEngine.tileMinSizePx"
              [style.minHeight.px]="gameEngine.tileMinSizePx"
              [class.cursor-pointer]="gameEngine.isValidMove(x, y)"
              [attr.title]="
                gameEngine.getUnitAt(x, y) &&
                (gameEngine.getUnitAt(x, y)!.owner === 'player' || gameEngine.isVisibleToPlayer(x, y))
                  ? gameEngine.formatHoverInfo(gameEngine.getUnitAt(x, y)!.id)
                  : gameEngine.isMine(x, y) && gameEngine.isVisibleToPlayer(x, y)
                    ? settings.currentLang() === 'uk'
                      ? '–ó–∞–ª—ñ–∑–Ω–∞ —à–∞—Ö—Ç–∞: –î–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –ø–æ—Ç—Ä—ñ–±–Ω–æ 5 –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–∏—Ö —Ö–æ–¥—ñ–≤ –∑–∞–π–Ω—è—Ç—Ç—è. –ü—ñ—Å–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –¥–∞—î +2 –∑–∞–ª—ñ–∑–∞ –∑–∞ —Ö—ñ–¥.'
                      : 'Iron Mine: Requires 5 consecutive turns of occupation to activate. Once active, yields +2 Iron per turn.'
                    : null
              "
              [attr.title]="
                gameEngine.getUnitAt(x, y) &&
                (gameEngine.getUnitAt(x, y)!.owner === 'player' || gameEngine.isVisibleToPlayer(x, y))
                  ? gameEngine.formatHoverInfo(gameEngine.getUnitAt(x, y)!.id)
                  : gameEngine.isForest(x, y) && gameEngine.isVisibleToPlayer(x, y)
                    ? settings.currentLang() === 'uk'
                      ? '–õ—ñ—Å–æ–ø–∏–ª—å–Ω—è: –î–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –ø–æ—Ç—Ä—ñ–±–Ω–æ 2 –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–∏—Ö —Ö–æ–¥—ñ–≤ –∑–∞–π–Ω—è—Ç—Ç—è. –ü—ñ—Å–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –¥–∞—î +8 –¥–µ—Ä–µ–≤–∏–Ω–∏ –∑–∞ —Ö—ñ–¥.'
                      : 'Sawmill: Requires 2 consecutive occupation turns to activate. Once activated, it gives +8 wood per turn.'
                    : null
              "
              [class.bg-gray-700]="!gameEngine.isValidMove(x, y)"
              [class.border-gray-600]="!gameEngine.isValidMove(x, y)"
              [class.bg-blue-900]="x === 0 && y === 0"
              [class.bg-red-900]="x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1"
              [class.border-4]="
                (x === 0 && y === 0) || (x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1)
              "
              [class.border-blue-400]="x === 0 && y === 0"
              [class.border-red-400]="x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1"
              [class.ring-2]="(x === 0 && y === 0) || (x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1)"
              [class.ring-blue-300]="x === 0 && y === 0 && gameEngine.baseDeployActive()"
              [class.ring-red-300]="x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1"
              [class.spawn-zone-highlight]="gameEngine.baseDeployActive() && x <= 2 && y <= 2 && (x !== 0 || y !== 0)"
              [class.forest-area]="gameEngine.isForest(x, y)"
              [class.mine-area]="gameEngine.isMine(x, y)"
              [class.forge-area]="gameEngine.isForge(x, y)"
              [class.bg-amber-900]="gameEngine.isDeployTarget(x, y) && !gameEngine.buildMode()"
              [class.border-amber-500]="gameEngine.isDeployTarget(x, y) && !gameEngine.buildMode()"
              [class.bg-gray-950]="!gameEngine.isVisibleToPlayer(x, y)"
              [class.border-gray-800]="!gameEngine.isVisibleToPlayer(x, y)"
              [class.bg-green-900]="gameEngine.isValidMove(x, y) && !gameEngine.getUnitAt(x, y)"
              [class.border-green-500]="gameEngine.isValidMove(x, y) && !gameEngine.getUnitAt(x, y)"
              [class.bg-cyan-900]="gameEngine.isValidMove(x, y) && gameEngine.getUnitAt(x, y)"
              [class.border-cyan-500]="gameEngine.isValidMove(x, y) && gameEngine.getUnitAt(x, y)"
              [class.animate-pulse]="gameEngine.isValidMove(x, y) && gameEngine.getUnitAt(x, y)"
              [class.hover:bg-gray-600]="!gameEngine.isValidMove(x, y)"
              [class.hover:bg-green-800]="gameEngine.isValidMove(x, y) && !gameEngine.getUnitAt(x, y)"
              [class.hover:bg-cyan-800]="gameEngine.isValidMove(x, y) && gameEngine.getUnitAt(x, y)"
            >
              <!-- Grid coordinate helper -->
              <span class="absolute top-0 right-0 text-[8px] text-gray-500 p-0.5 pointer-events-none">
                {{ x }},{{ y }}
              </span>
              @if (
                x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1 && gameEngine.isVisibleToPlayer(x, y)
              ) {
                @if (gameEngine.isRage()) {
                  <span
                    class="absolute -top-2 -right-2 text-xl [filter:drop-shadow(0_0_2px_rgba(0,0,0,0.5))]"
                    [style.z-index]="100"
                  >
                    ü§¨
                  </span>
                } @else if (gameEngine.isAngry()) {
                  <span
                    class="absolute -top-2 -right-2 text-xl [filter:drop-shadow(0_0_2px_rgba(0,0,0,0.5))]"
                    [style.z-index]="100"
                  >
                    üò†
                  </span>
                }
              }
              @if (gameEngine.buildMode() && gameEngine.isInSafeZone(x, y)) {
                <div
                  class="absolute inset-0 bg-red-800/20 border-2 border-red-500/40 border-dashed pointer-events-none"
                ></div>
              }
              @let unitOnTile = gameEngine.getUnitAt(x, y);
              @if (gameEngine.buildMode() && gameEngine.canBuildForgeAt(x, y)) {
                <button
                  class="absolute top-1 left-1 text-[10px] px-1.5 py-0.5 rounded bg-yellow-600/80 hover:bg-yellow-500 text-black shadow cursor-pointer"
                  (click)="gameEngine.buildForgeAt({ x: x, y: y })"
                  [style.z-index]="60"
                >
                  Build Forge
                </button>
              }
              @if (gameEngine.isForgeSite(x, y)) {
                <span
                  class="absolute bottom-1 left-1 text-[10px] font-bold px-1 rounded bg-yellow-400/80 text-black pointer-events-none"
                  [style.z-index]="55"
                >
                  {{ gameEngine.getForgeProgress(x, y) }}%
                </span>
              }
              @if (gameEngine.isForge(x, y)) {
                <span
                  class="absolute text-[10px] font-bold px-1 rounded bg-yellow-300/80 text-black pointer-events-none"
                  [style.z-index]="55"
                  [class.scale-60]="unitOnTile && unitOnTile.owner === 'player'"
                  [class.scale-50]="unitOnTile && unitOnTile.owner === 'player'"
                  [class.top-1]="!(unitOnTile && unitOnTile.owner === 'player')"
                  [class.left-1]="!(unitOnTile && unitOnTile.owner === 'player')"
                  [class.top-0]="unitOnTile && unitOnTile.owner === 'player'"
                  [class.-right-1]="unitOnTile && unitOnTile.owner === 'player'"
                >
                  Forge
                </span>
                @if (gameEngine.isVisibleToPlayer(x, y)) {
                  <span
                    class="absolute inset-0 pointer-events-none flex items-center justify-center opacity-90"
                    [style.z-index]="50"
                  >
                    <svg viewBox="0 0 128 128" class="w-full h-full">
                      <g transform="translate(0,10) scale(1)">
                        <rect x="20" y="80" width="88" height="18" rx="4" fill="#6b7280" />
                        <rect x="30" y="70" width="68" height="12" rx="3" fill="#9ca3af" />
                        <path d="M32 40 H96 L86 56 H42 Z" fill="#4b5563" />
                        <rect x="56" y="30" width="16" height="12" rx="2" fill="#6b7280" />
                        <rect x="60" y="20" width="8" height="12" rx="2" fill="#9ca3af" />
                      </g>
                    </svg>
                  </span>
                }
                @if (unitOnTile && unitOnTile.owner === 'player') {
                  <div class="absolute bottom-1 right-1 flex gap-1 flex-col" [style.z-index]="60">
                    @if (!unitOnTile.hasWeapon && gameEngine.resources().iron >= 20) {
                      <button
                        class="text-[9px] px-1 py-0.5 rounded bg-indigo-500 hover:bg-indigo-400 text-white shadow cursor-pointer"
                        (click)="gameEngine.buyWeapon(unitOnTile.id)"
                      >
                        Weapon
                      </button>
                    }
                    @if (!unitOnTile.hasArmor && gameEngine.resources().iron >= 20) {
                      <button
                        class="text-[9px] px-1 py-0.5 rounded bg-emerald-500 hover:bg-emerald-400 text-white shadow cursor-pointer"
                        (click)="gameEngine.buyArmor(unitOnTile.id)"
                      >
                        Armor
                      </button>
                    }
                  </div>
                }
              }
              @if (gameEngine.isForest(x, y) && gameEngine.isVisibleToPlayer(x, y)) {
                <span
                  class="absolute inset-0 pointer-events-none flex items-center justify-center transition-all duration-500"
                  [class.scale-50]="unitOnTile"
                  [class.opacity-40]="unitOnTile"
                  [class.translate-x-4]="unitOnTile"
                  [class.-translate-y-4]="unitOnTile"
                >
                  <svg viewBox="0 0 128 128" class="w-full h-full" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                      <linearGradient id="treeGrad" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="#9be7b3" />
                        <stop offset="100%" stop-color="#4f9f68" />
                      </linearGradient>
                    </defs>

                    @if (!unitOnTile) {
                      <g opacity="0.4">
                        <polygon points="28,60 12,90 22,90 8,112 48,112 34,90 44,90" fill="#1f3b2d" />
                        <polygon points="100,58 84,90 94,90 80,112 120,112 106,90 116,90" fill="#1f3b2d" />
                      </g>
                    }

                    <g [class.scale-90]="unitOnTile">
                      <polygon
                        points="64,22 36,66 50,66 28,98 100,98 78,66 92,66"
                        fill="url(#treeGrad)"
                        stroke="#1e3a2b"
                        stroke-width="4"
                        stroke-linejoin="round"
                      />
                      <rect x="58" y="98" width="12" height="16" fill="#3f7f5c" />
                    </g>

                    @if (!unitOnTile) {
                      <g transform="translate(10,105) scale(0.8)">
                        <rect width="60" height="12" rx="6" fill="#8b5a2b" stroke="#4a2a12" stroke-width="2" />
                      </g>
                      <g transform="translate(78, 30) rotate(15) scale(1.5)">
                        <rect width="4" height="30" rx="2" fill="#7a4a21" />
                        <path d="M0 0 C10 -2, 12 8, 2 12 Z" fill="#9aa3a8" transform="translate(4,0)" />
                      </g>
                    }
                  </svg>
                </span>
              }
              @if (gameEngine.isMine(x, y) && gameEngine.isVisibleToPlayer(x, y)) {
                <span
                  class="absolute inset-0 pointer-events-none flex items-center justify-center transition-all duration-500"
                  [class.scale-50]="unitOnTile"
                  [class.opacity-40]="unitOnTile"
                  [class.-translate-x-4]="unitOnTile"
                  [class.translate-y-4]="unitOnTile"
                >
                  <svg viewBox="0 0 128 128" class="w-full h-full" xmlns="http://www.w3.org/2000/svg">
                    <g>
                      <ellipse cx="64" cy="96" rx="40" ry="10" fill="#374151" />
                      <path d="M32 96 L56 48 L72 80 L96 96 Z" fill="#6b7280" stroke="#4b5563" stroke-width="4" />
                      <circle cx="58" cy="60" r="6" fill="#9ca3af" />
                    </g>
                    @if (!unitOnTile) {
                      <g transform="translate(82, 30) rotate(-20) scale(1.3)">
                        <rect width="4" height="30" rx="2" fill="#6b7280" />
                        <path d="M0 0 C10 -2, 12 8, 2 12 Z" fill="#f59e0b" transform="translate(4,0)" />
                      </g>
                    }
                  </svg>
                </span>
              }
              @if (gameEngine.isForest(x, y) && gameEngine.getUnitAt(x, y) && gameEngine.isVisibleToPlayer(x, y)) {
                <div
                  class="absolute top-0 left-0 right-0 bg-green-400/70 pointer-events-none"
                  [style.height.px]="2"
                ></div>
              }
              @if (x === 0 && y === 0) {
                <span
                  class="absolute inset-x-0 top-0 m-0.5 text-[10px] font-extrabold text-blue-900 bg-blue-300/80 rounded px-1 pointer-events-none"
                >
                  {{ gameEngine.baseHealth().player }}
                </span>
                <span
                  class="absolute left-0 bottom-0 m-0.5 text-[10px] font-extrabold text-white bg-blue-600/90 rounded px-1 pointer-events-none"
                >
                  {{ gameEngine.reservePoints().player }}
                </span>
              }
              @if (x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1) {
                @if (gameEngine.isVisibleToPlayer(x, y)) {
                  <span
                    class="absolute inset-x-0 top-0 m-0.5 text-[10px] font-extrabold text-red-900 bg-red-300/80 rounded px-1 pointer-events-none"
                  >
                    {{ gameEngine.baseHealth().ai }}
                  </span>
                  <span
                    class="absolute right-0 bottom-0 m-0.5 text-[10px] font-extrabold text-white bg-red-600/90 rounded px-1 pointer-events-none"
                  >
                    {{ gameEngine.reservePoints().ai }}
                  </span>
                }
              }

              @if (x < gameEngine.gridSize - 1) {
                @if (gameEngine.getWallBetween(x, y, x + 1, y); as vWall) {
                  @if (gameEngine.shouldRenderWall({ x: x, y: y }, { x: x + 1, y: y }, vWall.owner)) {
                    <div
                      class="absolute rounded-xs right-0 top-0 h-full flex items-center justify-center"
                      [style.right.px]="-gameEngine.wallThicknessPx - 2"
                      [style.width.px]="gameEngine.wallThicknessPx"
                      [style.height.%]="(vWall.health / (vWall.maxHealth || 100)) * 100"
                      [style.z-index]="40"
                      [style.transition]="'height 0.25s ease-out'"
                      [class.bg-blue-400]="vWall.owner === 'player'"
                      [class.bg-red-400]="vWall.owner === 'ai'"
                      [class.wall-formation-player]="vWall.owner === 'player'"
                      [class.wall-formation-ai]="vWall.owner === 'ai'"
                      [class.bg-gray-300]="vWall.owner === 'neutral'"
                      [class.shake]="gameEngine.isWallShaking(vWall.id)"
                      [class.wall-formation-active]="gameEngine.isFormationHovered(vWall.formationId)"
                      [attr.title]="
                        'Wall ' +
                        ((vWall.bonusHp || 0) > 0
                          ? '(Reinforced: +' + (vWall.bonusHp || 0) + ' HP from formation)'
                          : '') +
                        ' ‚Äî HP: ' +
                        vWall.health +
                        '/' +
                        (vWall.maxHealth || 100)
                      "
                      (mouseenter)="gameEngine.hoverFormationById(vWall.formationId)"
                      (mouseleave)="gameEngine.hoverFormationById(null)"
                    >
                      <!-- hover glow only -->
                      @if (gameEngine.canShowAttackIcon({ x: x, y: y }, { x: x + 1, y: y })) {
                        <button
                          class="absolute cursor-pointer shadow-2xl flex items-center justify-center text-white rounded-full border border-white/20 hover:scale-110 active:scale-95 transition-all z-[45]"
                          [style.width.px]="gameEngine.iconSizePx"
                          [style.height.px]="gameEngine.iconSizePx"
                          [style.z-index]="45"
                          [class.bg-red-600]="vWall.owner === 'player'"
                          [class.bg-yellow-500]="vWall.owner === 'ai'"
                          [class.bg-gray-600]="vWall.owner === 'neutral'"
                          (click)="
                            vWall.owner === 'player'
                              ? onDestroyIconClick($event, x, y, x + 1, y)
                              : onAttackIconClick($event, x, y, x + 1, y)
                          "
                        >
                          @if (vWall.owner === 'player') {
                            <svg class="w-1/2 h-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="3"
                                d="M6 18L18 6M6 6l12 12"
                              />
                            </svg>
                          } @else {
                            <svg class="w-1/2 h-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"
                              />
                            </svg>
                          }
                          <!-- {{ vWall.owner === 'player' ? '‚úñ' : '‚öî' }} -->
                        </button>
                      }
                    </div>
                  }
                } @else {
                  <div
                    class="absolute rounded-xs right-0 top-0 h-full flex items-center justify-center"
                    [style.right.px]="-gameEngine.wallThicknessPx - 2"
                    [style.width.px]="gameEngine.wallThicknessPx"
                    [style.height.%]="100"
                    [style.z-index]="40"
                    [style.transition]="'height 0.25s ease-out'"
                    [class.bg-lime-700]="
                      gameEngine.buildMode() && gameEngine.canBuildWallBetween({ x: x, y: y }, { x: x + 1, y: y })
                    "
                    [class.bg-transparent]="
                      !gameEngine.buildMode() || !gameEngine.canBuildWallBetween({ x: x, y: y }, { x: x + 1, y: y })
                    "
                  >
                    @if (gameEngine.canShowBuildIcon({ x: x, y: y }, { x: x + 1, y: y })) {
                      <button
                        class="bg-green-500 cursor-pointer text-white rounded-full shadow-lg flex items-center justify-center p-1"
                        [style.fontSize.px]="gameEngine.iconSizePx"
                        [style.width.px]="gameEngine.iconSizePx"
                        [style.height.px]="gameEngine.iconSizePx"
                        [style.z-index]="45"
                        (click)="onBuildIconClick($event, x, y, x + 1, y)"
                      >
                        ‚úî
                      </button>
                    }
                    @if (
                      gameEngine.buildMode() &&
                      (gameEngine.isVisibleToPlayer(x, y) || gameEngine.isVisibleToPlayer(x + 1, y)) &&
                      gameEngine.edgeCooldownRemaining({ x: x, y: y }, { x: x + 1, y: y }) > 0
                    ) {
                      <span class="absolute whitespace-nowrap right-0 top-0 text-[8px] text-yellow-300 px-1">
                        {{ settings.t('CD') }}:
                        {{ gameEngine.edgeCooldownRemaining({ x: x, y: y }, { x: x + 1, y: y }) }}
                      </span>
                    }
                  </div>
                }
              }

              @if (y < gameEngine.gridSize - 1) {
                @if (gameEngine.getWallBetween(x, y, x, y + 1); as hWall) {
                  @if (gameEngine.shouldRenderWall({ x: x, y: y }, { x: x, y: y + 1 }, hWall.owner)) {
                    <div
                      class="absolute rounded-xs left-0 bottom-0 w-full flex items-center justify-center"
                      [style.bottom.px]="-gameEngine.wallThicknessPx - 2"
                      [style.height.px]="gameEngine.wallThicknessPx"
                      [style.width.%]="(hWall.health / (hWall.maxHealth || 100)) * 100"
                      [style.z-index]="40"
                      [style.transition]="'width 0.25s ease-out'"
                      [class.bg-blue-400]="hWall.owner === 'player'"
                      [class.bg-red-400]="hWall.owner === 'ai'"
                      [class.wall-formation-player]="hWall.owner === 'player'"
                      [class.wall-formation-ai]="hWall.owner === 'ai'"
                      [class.bg-gray-300]="hWall.owner === 'neutral'"
                      [class.shake]="gameEngine.isWallShaking(hWall.id)"
                      [class.wall-formation-active]="gameEngine.isFormationHovered(hWall.formationId)"
                      [attr.title]="
                        'Wall ' +
                        ((hWall.bonusHp || 0) > 0
                          ? '(Reinforced: +' + (hWall.bonusHp || 0) + ' HP from formation)'
                          : '') +
                        ' ‚Äî HP: ' +
                        hWall.health +
                        '/' +
                        (hWall.maxHealth || 100)
                      "
                      (mouseenter)="gameEngine.hoverFormationById(hWall.formationId)"
                      (mouseleave)="gameEngine.hoverFormationById(null)"
                    >
                      <!-- hover glow only -->
                      @if (gameEngine.canShowAttackIcon({ x: x, y: y }, { x: x, y: y + 1 })) {
                        <button
                          class="absolute cursor-pointer shadow-2xl flex items-center justify-center text-white rounded-full border border-white/20 hover:scale-110 active:scale-95 transition-all z-[45]"
                          [style.width.px]="gameEngine.iconSizePx"
                          [style.height.px]="gameEngine.iconSizePx"
                          [style.z-index]="45"
                          [class.bg-red-600]="hWall.owner === 'player'"
                          [class.bg-yellow-500]="hWall.owner === 'ai'"
                          [class.bg-gray-600]="hWall.owner === 'neutral'"
                          (click)="
                            hWall.owner === 'player'
                              ? onDestroyIconClick($event, x, y, x, y + 1)
                              : onAttackIconClick($event, x, y, x, y + 1)
                          "
                        >
                          @if (hWall.owner === 'player') {
                            <svg class="w-1/2 h-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="3"
                                d="M6 18L18 6M6 6l12 12"
                              />
                            </svg>
                          } @else {
                            <svg class="w-1/2 h-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"
                              />
                            </svg>
                          }
                          <!-- {{ hWall.owner === 'player' ? '‚úñ' : '‚öî' }} -->
                        </button>
                      }
                    </div>
                  }
                } @else {
                  <div
                    class="absolute rounded-xs left-0 bottom-0 w-full flex items-center justify-center"
                    [style.bottom.px]="-gameEngine.wallThicknessPx - 2"
                    [style.height.px]="gameEngine.wallThicknessPx"
                    [style.width.%]="100"
                    [style.z-index]="40"
                    [style.transition]="'width 0.25s ease-out'"
                    [class.bg-lime-700]="
                      gameEngine.buildMode() && gameEngine.canBuildWallBetween({ x: x, y: y }, { x: x, y: y + 1 })
                    "
                    [class.bg-transparent]="
                      !gameEngine.buildMode() || !gameEngine.canBuildWallBetween({ x: x, y: y }, { x: x, y: y + 1 })
                    "
                  >
                    @if (gameEngine.canShowBuildIcon({ x: x, y: y }, { x: x, y: y + 1 })) {
                      <button
                        class="bg-green-500 cursor-pointer text-white rounded-full shadow-lg flex items-center justify-center"
                        [style.fontSize.px]="gameEngine.iconSizePx"
                        [style.width.px]="gameEngine.iconSizePx"
                        [style.height.px]="gameEngine.iconSizePx"
                        [style.z-index]="45"
                        (click)="onBuildIconClick($event, x, y, x, y + 1)"
                      >
                        ‚úî
                      </button>
                    }
                    @if (
                      gameEngine.buildMode() &&
                      (gameEngine.isVisibleToPlayer(x, y) || gameEngine.isVisibleToPlayer(x, y + 1)) &&
                      gameEngine.edgeCooldownRemaining({ x: x, y: y }, { x: x, y: y + 1 }) > 0
                    ) {
                      <span class="absolute whitespace-nowrap left-0 bottom-0 text-[8px] text-yellow-300 px-1">
                        {{ settings.t('CD') }}:
                        {{ gameEngine.edgeCooldownRemaining({ x: x, y: y }, { x: x, y: y + 1 }) }}
                      </span>
                    }
                  </div>
                }
              }

              @if (gameEngine.getUnitAt(x, y); as unit) {
                @if (unit.owner === 'player' || gameEngine.isVisibleToPlayer(x, y)) {
                  @if (!(x === 0 && y === 0) && !(x === gameEngine.gridSize - 1 && y === gameEngine.gridSize - 1)) {
                    <div
                      class="pointer-events-none move-anim"
                      [class.shake]="gameEngine.isUnitShaking(unit.id)"
                      [style.transform]="gameEngine.getCombinedTransform(unit.id)"
                      [style.z-index]="
                        gameEngine.isUnitMoving(unit.id) || gameEngine.isUnitAttacking(unit.id) ? 200 : null
                      "
                    >
                      <!-- [class.ring-4]="gameEngine.selectedUnitId() === unit.id"
                        [class.ring-yellow-400]="gameEngine.selectedUnitId() === unit.id"
                        [class.ring-offset-2]="gameEngine.selectedUnitId() === unit.id" -->
                      <div
                        class="unit-svg-wrapper"
                        [class.theme-player]="unit.owner === 'player'"
                        [class.theme-ai]="unit.owner === 'ai'"
                        [class.fatigued]="unit.hasActed"
                        [class.merge-anim]="gameEngine.lastMergedUnitId() === unit.id"
                        [style.width.px]="gameEngine.tileUnitSizePx"
                        [style.height.px]="gameEngine.tileUnitSizePx"
                        [attr.title]="gameEngine.formatHoverInfo(unit.id)"
                        [class.ring]="gameEngine.selectedUnitId() === unit.id"
                        [class.ring-yellow-400]="gameEngine.selectedUnitId() === unit.id"
                        [class.ring-offset-gray-800]="gameEngine.selectedUnitId() === unit.id"
                        [class.scale-115]="gameEngine.selectedUnitId() === unit.id && !gameEngine.buildMode()"
                        [class.scale-120]="gameEngine.lastMergedUnitId() === unit.id"
                        [class.scale-50]="gameEngine.buildMode()"
                        [class.animate-bounce]="gameEngine.lastRemainderUnitId() === unit.id"
                        [class.arrival-pop]="gameEngine.lastArrivedUnitId() === unit.id"
                        [class.pulse-glow]="gameEngine.pulseUnitId() === unit.id"
                      >
                        @if (unit) {
                          <app-units [unit]="unit" />
                        }
                      </div>
                      @if (gameEngine.isUnitHovered(unit.id) && gameEngine.getHitChanceInfo(unit.id); as hc) {
                        <span
                          class="absolute -top-1 -left-1 px-0.5 py-0.5 rounded text-white text-[8px] font-bold pointer-events-none shadow"
                          [class.bg-green-600]="hc.bg === 'bg-green-600'"
                          [class.bg-amber-600]="hc.bg === 'bg-amber-600'"
                          [class.bg-red-600]="hc.bg === 'bg-red-600'"
                          [style.z-index]="200"
                        >
                          {{ hc.chance }}%
                        </span>
                      }
                      <!-- @if (gameEngine.hasDefenseBonus(unit)) {
                        <span
                          class="absolute -top-1 -right-1 rounded-full bg-blue-200 text-blue-900 flex items-center justify-center"
                          [style.width.px]="gameEngine.iconSizePx"
                          [style.height.px]="gameEngine.iconSizePx"
                          [style.fontSize.px]="gameEngine.iconSizePx - 2 > 8 ? gameEngine.iconSizePx - 2 : 8"
                          [style.z-index]="100"
                        >
                          üõ°
                        </span>
                      } -->
                      @if (unit.productionActive) {
                        <span
                          class="absolute -bottom-1 -right-1 [filter:drop-shadow(0_0_2px_rgba(0,0,0,0.5))]"
                          [style.z-index]="100"
                        >
                          üå≥
                        </span>
                      } @else if ((unit.forestOccupationTurns ?? 0) === 1) {
                        <span
                          class="absolute -bottom-1 -right-1 opacity-70 [filter:drop-shadow(0_0_2px_rgba(0,0,0,0.5))]"
                          [style.z-index]="100"
                        >
                          üå±
                        </span>
                      } @else if ((unit.forestOccupationTurns ?? 0) > 1) {
                        <span
                          class="absolute -bottom-1 -right-1 opacity-70 [filter:drop-shadow(0_0_2px_rgba(0,0,0,0.5))]"
                          [style.z-index]="100"
                        >
                          üåø
                        </span>
                      }
                      @if (gameEngine.isMine(unit.position.x, unit.position.y)) {
                        @if ((unit.mineOccupationTurns ?? 0) >= 5) {
                          <span
                            class="absolute -bottom-1 -left-1 [filter:drop-shadow(0_0_2px_rgba(0,0,0,0.5))]"
                            [style.z-index]="100"
                          >
                            üß±
                          </span>
                        } @else if ((unit.mineOccupationTurns ?? 0) === 1) {
                          <span class="absolute -bottom-1 -left-1 opacity-70 [style.z-index]='100'">‚õ∞Ô∏è</span>
                        } @else if ((unit.mineOccupationTurns ?? 0) === 2) {
                          <span class="absolute -bottom-1 -left-1 opacity-70 [style.z-index]='100'">‚õèÔ∏è</span>
                        } @else if ((unit.mineOccupationTurns ?? 0) === 3) {
                          <span class="absolute -bottom-1 -left-1 opacity-70 [style.z-index]='100'">‚õè</span>
                        } @else if ((unit.mineOccupationTurns ?? 0) > 3) {
                          <span class="absolute -bottom-1 -left-1 opacity-70 [style.z-index]='100'">‚öí</span>
                        }
                      }
                    </div>
                  }
                }
              }

              @for (entry of gameEngine.getCombatTextEntriesAt(x, y); track entry.id) {
                <div
                  class="absolute inset-0 flex items-center justify-center pointer-events-none transition-opacity duration-500 combat-text-anim"
                  [style.z-index]="100"
                  [style.opacity]="entry.opacity"
                >
                  <span
                    [class.text-xs]="!gameEngine.isLuckyText(entry.text) && !gameEngine.isDrawText(entry.text)"
                    [class.text-base]="gameEngine.isLuckyText(entry.text) || gameEngine.isDrawText(entry.text)"
                    [class.text-yellow-300]="!gameEngine.isLuckyText(entry.text) && !gameEngine.isDrawText(entry.text)"
                    [class.text-yellow-400]="gameEngine.isLuckyText(entry.text) || gameEngine.isDrawText(entry.text)"
                    class="font-extrabold"
                  >
                    {{ entry.text }}
                  </span>
                </div>
              }
            </div>
          }
        }
      </div>
    </div>

    <!-- Difficulty SIDE -->
    <div class="mt-4 absolute top-0 right-[-184px] min-w-[170px]">
      <div
        class="relative p-4 rounded-2xl bg-gray-900/40 backdrop-blur-md border border-white/10 shadow-2xl overflow-hidden group"
      >
        <div
          class="absolute -top-10 -right-10 w-24 h-24 blur-[40px] opacity-20 transition-colors duration-500"
          [class.bg-lime-400]="'baby' === settings.difficulty()"
          [class.bg-emerald-400]="'normal' === settings.difficulty()"
          [class.bg-orange-500]="'hard' === settings.difficulty()"
          [class.bg-red-600]="'nightmare' === settings.difficulty()"
        ></div>

        <div class="relative z-10 flex flex-col gap-1">
          <span class="text-[10px] uppercase tracking-[0.2em] text-stone-400 font-black">{{ settings.t('RISK') }}</span>

          <div class="flex items-center justify-between">
            <span
              class="font-mono text-xl font-bold capitalize tracking-tight transition-colors duration-300"
              [class.text-lime-300]="'baby' === settings.difficulty()"
              [class.text-emerald-300]="'normal' === settings.difficulty()"
              [class.text-orange-400]="'hard' === settings.difficulty()"
              [class.text-red-500]="'nightmare' === settings.difficulty()"
            >
              {{ settings.t(settings.getDifficultyLabel(settings.difficulty())) }}
            </span>

            <div
              class="flex items-center justify-center w-8 h-8 rounded-lg bg-white/5 border border-white/10 shadow-inner"
            >
              <span class="text-lg">
                {{
                  'baby' === settings.difficulty()
                    ? 'üë∂'
                    : 'normal' === settings.difficulty()
                      ? 'ü§†'
                      : 'hard' === settings.difficulty()
                        ? 'üòà'
                        : '‚ò†Ô∏è'
                }}
              </span>
            </div>
          </div>

          <div class="mt-2 h-[4px] w-full bg-gray-800 rounded-full overflow-hidden">
            <div
              class="h-full transition-all duration-700 ease-out shadow-[0_0_8px]"
              [style.width.%]="
                'baby' === settings.difficulty()
                  ? 25
                  : 'normal' === settings.difficulty()
                    ? 50
                    : 'hard' === settings.difficulty()
                      ? 75
                      : 100
              "
              [class.bg-lime-400]="'baby' === settings.difficulty()"
              [class.bg-emerald-400]="'normal' === settings.difficulty()"
              [class.bg-orange-500]="'hard' === settings.difficulty()"
              [class.bg-red-600]="'nightmare' === settings.difficulty()"
            ></div>
          </div>
        </div>
      </div>
    </div>
    <!-- Player Actions -->
    <div
      class="mt-4 flex flex-col items-start gap-2 absolute top-0 left-[-208px] p-4 rounded-2xl bg-gray-900/40 backdrop-blur-md border border-white/10 shadow-2xl"
    >
      <div class="flex gap-2 flex-col w-full">
        <button
          (click)="toggleAutoBattle()"
          class="cursor-pointer group relative px-4 py-3 rounded-xl text-sm font-bold transition-all duration-200 flex items-center justify-between gap-3 overflow-hidden border border-green-400/30 bg-gradient-to-br from-green-600/20 to-green-800/40 hover:from-green-500/40 hover:to-green-700/60 shadow-[0_0_15px_rgba(34,197,94,0.2)] active:scale-95 disabled:opacity-40 disabled:grayscale disabled:cursor-not-allowed"
          [class.ring-2]="isAutoBattleActive()"
          [class.ring-green-400]="isAutoBattleActive()"
          [disabled]="gameEngine.gameStatus() !== 'playing'"
        >
          <div class="flex items-center gap-2 z-10">
            <span class="text-green-200 text-xs tracking-widest uppercase">{{ settings.t('AUTO') }}</span>
            <span class="text-white">{{ settings.t('ENGAGE') }}</span>
          </div>
          <div class="flex items-center gap-2 z-10">
            <span
              class="h-2 w-2 rounded-full"
              [class.bg-green-400]="isAutoBattleActive()"
              [class.bg-gray-500]="!isAutoBattleActive()"
            ></span>
          </div>
          <div
            class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite] pointer-events-none"
          ></div>
        </button>
        <button
          (click)="gameEngine.toggleBuildMode()"
          class="cursor-pointer group relative px-4 py-3 rounded-xl text-sm font-bold transition-all duration-200 flex items-center justify-between gap-3 overflow-hidden border border-blue-400/30 bg-gradient-to-br from-blue-600/20 to-blue-800/40 hover:from-blue-500/40 hover:to-blue-700/60 shadow-[0_0_15px_rgba(59,130,246,0.2)] active:scale-95 disabled:opacity-40 disabled:grayscale disabled:cursor-not-allowed"
          [class.ring-2]="gameEngine.buildMode()"
          [class.ring-blue-400]="gameEngine.buildMode()"
          [disabled]="gameEngine.wallBuiltThisTurn() || !gameEngine.canBuildThisTurn()"
        >
          <div class="flex items-center gap-0 z-10">
            <span class="text-blue-200">+1</span>
            <div class="scale-95 origin-center">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M4 20V8L6 5L8 8V20" fill="#8B5E3C" stroke="#5D4037" stroke-width="1" />
                <path d="M9 20V6L11 3L13 6V20" fill="#A67B5B" stroke="#5D4037" stroke-width="1" />
                <path d="M14 20V8L16 5L18 8V20" fill="#8B5E3C" stroke="#5D4037" stroke-width="1" />
                <rect x="3" y="12" width="18" height="2" fill="#5D4037" />
              </svg>
            </div>
          </div>
          <div class="flex flex-center bg-black/40 px-2 py-1 rounded-lg border border-white/10 z-10 text-red-300">
            <span>-10</span>
            <div class="w-6 h-6 flex-shrink-0 rotate-90">
              <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                <rect x="8" y="26" width="48" height="14" rx="7" fill="#c68642" stroke="#8b5a2b" stroke-width="3" />

                <circle cx="14" cy="33" r="3" fill="#8b5a2b" />
                <circle cx="50" cy="33" r="3" fill="#8b5a2b" />
              </svg>
            </div>
          </div>
          <div
            class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite] pointer-events-none"
          ></div>
        </button>

        <button
          (click)="gameEngine.convertWoodToReserve()"
          [disabled]="!gameEngine.canAddReserveTurn()"
          class="cursor-pointer group relative px-4 py-3 rounded-xl text-sm font-bold transition-all duration-200 border border-emerald-400/30 bg-gradient-to-br from-emerald-600/20 to-emerald-800/40 hover:from-emerald-500/40 hover:to-emerald-700/60 shadow-[0_0_15px_rgba(16,185,129,0.1)] active:scale-95 disabled:opacity-40 disabled:grayscale disabled:cursor-not-allowed"
        >
          <div class="flex items-center justify-between w-full gap-0 z-10">
            <span class="flex flex-center text-emerald-200">
              <span>20</span>
              <div class="w-6 h-6 flex-shrink-0 rotate-90">
                <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                  <rect x="8" y="26" width="48" height="14" rx="7" fill="#c68642" stroke="#8b5a2b" stroke-width="3" />

                  <circle cx="14" cy="33" r="3" fill="#8b5a2b" />
                  <circle cx="50" cy="33" r="3" fill="#8b5a2b" />
                </svg>
              </div>
            </span>
            <span class="text-lg">‚ûî</span>
            <span class="text-emerald-200 text-lg">1 üë§</span>
          </div>
        </button>

        <button
          (click)="gameEngine.maxConvertWoodToReserve()"
          [disabled]="!gameEngine.canAddReserveTurn()"
          class="cursor-pointer group relative px-4 py-3 rounded-xl text-sm font-bold transition-all duration-200 border border-amber-400/30 bg-gradient-to-br from-amber-600/20 to-amber-800/40 hover:from-amber-500/40 hover:to-amber-700/60 shadow-[0_0_15px_rgba(245,158,11,0.1)] active:scale-95 disabled:opacity-40 disabled:grayscale disabled:cursor-not-allowed"
        >
          <div class="flex items-center justify-between w-full gap-0 z-10 text-amber-200">
            <span class="text-xs uppercase tracking-tighter">{{ settings.t('ALL') }}</span>
            <span class="text-lg">‚ûî</span>
            <span class="text-lg">üë•++</span>
          </div>
        </button>
      </div>

      <label
        class="mt-2 flex items-center gap-3 w-full px-2 py-2 rounded-lg hover:bg-white/5 transition-colors cursor-pointer border border-transparent hover:border-white/5"
      >
        <div class="relative flex items-center">
          <input
            type="checkbox"
            class="peer h-4 w-4 opacity-0 absolute"
            [checked]="gameEngine.fogDebugDisabled()"
            (change)="gameEngine.toggleFogDebug()"
          />
          <div
            class="h-4 w-4 border-2 border-gray-500 rounded flex items-center justify-center peer-checked:bg-blue-500 peer-checked:border-blue-500 transition-all"
          >
            <div class="h-2 w-2 bg-white rounded-full opacity-0 peer-checked:opacity-100"></div>
          </div>
        </div>
        <span class="text-[10px] uppercase tracking-widest text-gray-400 font-bold">{{ settings.t('MAP_HACK') }}</span>
      </label>

      <!-- <label
        class="flex items-center gap-3 w-full px-2 py-2 rounded-lg hover:bg-white/5 transition-colors cursor-pointer border border-transparent hover:border-white/5"
      >
        <div class="relative flex items-center">
          <input
            type="checkbox"
            class="peer h-4 w-4 opacity-0 absolute"
            [checked]="gameEngine.autoDeployEnabled()"
            (change)="gameEngine.toggleAutoDeploy()"
          />
          <div
            class="h-4 w-4 border-2 border-gray-500 rounded flex items-center justify-center peer-checked:bg-blue-500 peer-checked:border-blue-500 transition-all"
          >
            <div class="h-2 w-2 bg-white rounded-full opacity-0 peer-checked:opacity-100"></div>
          </div>
        </div>
        <span class="text-[10px] uppercase tracking-widest text-gray-400 font-bold">Auto-Deploy</span>
      </label> -->
      <button
        (click)="gameEngine.endPlayerTurn()"
        class="cursor-pointer group relative px-4 py-3 rounded-xl text-sm font-bold transition-all duration-200 border border-amber-400/30 bg-gradient-to-br from-amber-600/20 to-amber-800/40 hover:from-amber-500/40 hover:to-amber-700/60 shadow-[0_0_15px_rgba(245,158,11,0.1)] active:scale-95 disabled:opacity-40 disabled:grayscale disabled:cursor-not-allowed"
      >
        <div class="flex items-center justify-between w-full gap-2 z-10 text-amber-200">
          <span class="text-xs uppercase tracking-tighter">{{ settings.t('NEXT_TURN') }}</span>

          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M5 12h14"></path>
            <path d="m12 5 7 7-7 7"></path>
          </svg>
        </div>
      </button>
      <div class="mt-1 text-[10px] uppercase tracking-widest font-bold text-gray-300">
        {{ settings.currentLang() === 'uk' ? '–ó–∞–ª–∏—à–∏–ª–æ—Å—å –¥—ñ–π' : 'Remaining actions' }}:
        {{ gameEngine.remainingActions() }}/{{ gameEngine.totalPlayerUnits() }}
      </div>
    </div>
    <!-- Actions END -->
  </div>

  <!-- -------------------------------------------- Version -------------------------------------------- -->
  <div class="fixed bottom-2 left-2 text-[8px] text-gray-300">
    {{ settings.version }} | ¬©Ô∏é Created by jaerbi and just
  </div>

  <!-- Game Rules Modal -->
  @if (gameEngine.rulesOpen()) {
    <app-game-rules />
  }
  <!-- Game Rules Modal END -->
  <!-- Log Modal -->
  @if (gameEngine.logOpen()) {
    <div
      class="fixed inset-y-0 right-0 w-85 bg-black/60 backdrop-blur-md border-l border-white/10 p-6 z-50 shadow-2xl flex flex-col transition-all duration-300"
    >
      <button
        class="w-10 h-10 absolute top-4 -left-5 rounded-full bg-[#1e293b] border border-white/20 hover:bg-[#334155] text-white shadow-lg flex items-center justify-center transition-transform hover:scale-110 cursor-pointer"
        (click)="gameEngine.toggleLog()"
      >
        <span class="text-xl">‚úï</span>
      </button>

      <div class="border-b border-white/10 pb-4 mb-4">
        <div class="flex items-center justify-between mb-2">
          <h3
            class="text-xl font-black uppercase tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400"
          >
            {{ settings.t('Action_LOG') }}
          </h3>

          <button
            (click)="gameEngine.clearLogs()"
            class="flex items-center gap-1.5 px-2 py-1 rounded bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 text-red-400 text-[10px] uppercase font-bold tracking-wider transition-all hover:scale-105 active:scale-95 cursor-pointer"
            title="Clear all logs"
          >
            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
              />
            </svg>
            {{ settings.t('CLEAR') }}
          </button>
        </div>

        <label class="flex items-center gap-3 group cursor-pointer">
          <div class="relative flex items-center">
            <input
              type="checkbox"
              class="peer h-5 w-5 opacity-0 absolute cursor-pointer"
              [checked]="gameEngine.combatOnly()"
              (change)="gameEngine.toggleCombatOnly()"
            />
            <div
              class="h-5 w-5 border-2 border-white/30 rounded bg-white/5 peer-checked:bg-blue-500 peer-checked:border-blue-400 transition-all"
            ></div>
            <svg
              class="absolute h-3.5 w-3.5 text-white opacity-0 peer-checked:opacity-100 left-0.5 pointer-events-none"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <span class="text-sm font-medium text-gray-300 group-hover:text-white transition-colors">
            {{ settings.t('COMBAT_ONLY') }}
          </span>
        </label>
      </div>

      <div class="flex-1 overflow-y-auto pr-2 space-y-3 custom-scrollbar">
        @if (gameEngine.logsFiltered().length === 0) {
          <div class="text-center py-10 text-gray-500 italic text-sm">{{ settings.t('NOT_LOGS_DATA') }}</div>
        }

        @for (entry of gameEngine.logsFiltered().reverse(); track $index) {
          <div
            class="p-3 rounded-lg bg-white/5 border border-white/5 hover:bg-white/10 transition-colors text-[13px] leading-relaxed shadow-sm animate-in fade-in slide-in-from-right-4 duration-300"
            [class.border-l-4]="
              entry.color.includes('green') || entry.color.includes('red') || entry.color.includes('yellow')
            "
            [style.border-left-color]="
              entry.color.includes('green')
                ? '#4ade80'
                : entry.color.includes('red')
                  ? '#f87171'
                  : entry.color.includes('yellow')
                    ? '#fde047'
                    : 'transparent'
            "
          >
            <span [class]="entry.color" class="font-medium">{{ entry.text }}</span>
          </div>
        }
      </div>
    </div>
  }
  <!-- Log Modal END -->
  <!-- Settings Modal -->
  @if (gameEngine.settingsOpen()) {
    <div
      class="fixed inset-y-0 left-0 w-72 bg-black/60 backdrop-blur-xl border-r border-white/10 p-6 z-50 shadow-[10px_0_30px_rgba(0,0,0,0.5)] flex flex-col gap-[24px] transition-all animate-in slide-in-from-left duration-300"
    >
      <div class="relative flex items-center gap-3 border-b border-white/5 pb-4">
        <div class="w-2 h-6 bg-blue-500 rounded-full shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
        <h3 class="text-xl font-black uppercase tracking-widest text-white/90">{{ settings.t('SYSTEM_SETTINGS') }}</h3>
        <button
          class="w-8 h-8 absolute top-0 -right-10 rounded-full bg-gray-700 hover:bg-gray-600 text-lg cursor-pointer"
          (click)="gameEngine.toggleSettings()"
        >
          ‚úñ
        </button>
      </div>

      <div class="flex flex-col gap-4">
        <div class="flex items-center justify-between">
          <label class="text-[10px] font-black uppercase tracking-widest text-stone-400">
            {{ settings.t('TACTICAL_DIFF') }}
          </label>
          <span class="text-[10px] px-2 py-0.5 rounded bg-white/5 border border-white/10 text-stone-300 italic">
            {{ settings.t('LEVEL_SELECTION') }}
          </span>
        </div>

        <div class="grid grid-cols-2 gap-2">
          @for (diff of settings.diffArr; track diff) {
            <button
              (click)="onDifficultyChange(diff)"
              class="px-3 py-2 rounded-xl text-xs font-bold capitalize cursor-pointer transition-all duration-200 border flex items-center justify-center gap-2 group"
              [class.bg-blue-500/20]="settings.difficulty() === diff"
              [class.border-blue-400/40]="settings.difficulty() === diff"
              [class.text-blue-200]="settings.difficulty() === diff"
              [class.shadow-[0_0_15px_rgba(59,130,246,0.2)]]="settings.difficulty() === diff"
              [class.bg-white/5]="settings.difficulty() !== diff"
              [class.border-white/5]="settings.difficulty() !== diff"
              [class.text-stone-500]="settings.difficulty() !== diff"
              [class.hover:bg-white/10]="settings.difficulty() !== diff"
            >
              <span
                class="opacity-0 group-hover:opacity-100 transition-opacity"
                [class.opacity-100]="settings.difficulty() === diff"
              >
                {{ diff === 'baby' ? 'üë∂' : diff === 'normal' ? 'ü§†' : diff === 'hard' ? 'üòà' : '‚ò†Ô∏è' }}
              </span>
              {{ settings.t(settings.getDifficultyLabel(diff)) }}
            </button>
          }
        </div>
      </div>

      <div class="flex flex-col gap-4">
        <label class="text-[10px] font-black uppercase tracking-widest text-stone-400 ml-1 text-left">
          {{ settings.t('SECTOR_DIMENSIONS') }}
        </label>

        <div class="flex p-1 bg-black/40 rounded-2xl border border-white/5 shadow-inner">
          @for (size of [10, 20, 30]; track size) {
            <button
              (click)="onMapSizeChange(size)"
              class="cursor-pointer flex-1 py-2 rounded-xl text-xs font-bold transition-all duration-300"
              [class.bg-gradient-to-br]="settings.mapSize() === size"
              [class.from-indigo-600]="settings.mapSize() === size"
              [class.to-indigo-800]="settings.mapSize() === size"
              [class.text-white]="settings.mapSize() === size"
              [class.shadow-lg]="settings.mapSize() === size"
              [class.text-stone-500]="settings.mapSize() !== size"
              [class.hover:text-stone-300]="settings.mapSize() !== size"
            >
              {{ size }}x{{ size }}
            </button>
          }
        </div>
      </div>

      <div class="flex items-center gap-1 px-1 py-0.5 rounded-full bg-white/5 border border-white/10">
        <button
          (click)="settings.setLang('uk')"
          class="cursor-pointer text-[9px] font-black uppercase tracking-widest px-2 py-0.5 rounded-full"
          [class.text-blue-300]="settings.currentLang() === 'uk'"
          [class.text-stone-400]="settings.currentLang() !== 'uk'"
        >
          UA
        </button>
        <button
          (click)="settings.setLang('en')"
          class="cursor-pointer text-[9px] font-black uppercase tracking-widest px-2 py-0.5 rounded-full"
          [class.text-blue-300]="settings.currentLang() === 'en'"
          [class.text-stone-400]="settings.currentLang() !== 'en'"
        >
          EN
        </button>
      </div>
      <label
        class="mt-3 flex items-center gap-3 w-full px-2 py-2 rounded-lg hover:bg-white/5 transition-colors cursor-pointer border border-transparent hover:border-white/5"
      >
        <div class="relative flex items-center">
          <input
            type="checkbox"
            class="peer h-4 w-4 opacity-0 absolute"
            [checked]="settings.customMode()"
            (change)="setCustomMode($any($event.target).checked)"
          />
          <div
            class="h-4 w-4 border-2 border-gray-500 rounded flex items-center justify-center peer-checked:bg-pink-500 peer-checked:border-pink-500 transition-all"
          >
            <div class="h-2 w-2 bg-white rounded-full opacity-0 peer-checked:opacity-100"></div>
          </div>
        </div>
        <span class="text-[10px] uppercase tracking-widest text-gray-400 font-bold">Custom Mode</span>
      </label>
    </div>
  }
  <!-- Settings Modal End -->
  <!-- High Scores Modal -->
  @if (gameEngine.highScoresOpen()) {
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-600 w-[680px] max-w-[95vw]">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-2xl font-bold">{{ settings.t('HIGH_SCORES') }}</h2>
          <button
            class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-700 hover:bg-gray-600 text-lg cursor-pointer"
            (click)="gameEngine.closeHighScores()"
          >
            ‚úñ
          </button>
        </div>
        <div class="text-sm text-gray-300 mb-2">
          {{ settings.t('CURRENT') }}: {{ settings.t(settings.difficultyLabel()) }} ‚Ä¢ {{ settings.mapSizeLabel() }}
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-gray-800/60 border border-gray-700 rounded-lg p-3">
            <h3 class="text-lg font-semibold mb-2 text-green-400">{{ settings.t('TOP_3_PLAYER') }}</h3>
            @for (s of gameEngine.getHighScoresForCurrentCombo().wins; track s.date) {
              <div class="flex justify-between text-sm">
                <span>{{ s.date | date: 'yyyy-MM-dd HH:mm' }}</span>
                <span class="font-mono">{{ s.condition }}</span>
                <span class="font-mono text-yellow-300">{{ s.turns }} {{ settings.t('TURNS') }}</span>
              </div>
            } @empty {
              <div class="text-xs text-gray-400">{{ settings.t('NO_RECORDS_YET') }}</div>
            }
          </div>
          <div class="bg-gray-800/60 border border-gray-700 rounded-lg p-3">
            <h3 class="text-lg font-semibold mb-2 text-red-400">{{ settings.t('TOP_3_LOSES_PLAYER') }}</h3>
            @for (s of gameEngine.getHighScoresForCurrentCombo().losses; track s.date) {
              <div class="flex justify-between text-sm">
                <span>{{ s.date | date: 'yyyy-MM-dd HH:mm' }}</span>
                <span class="font-mono">{{ s.condition }}</span>
                <span class="font-mono text-yellow-300">{{ s.turns }} {{ settings.t('TURNS') }}</span>
              </div>
            } @empty {
              <div class="text-xs text-gray-400">{{ settings.t('NO_RECORDS_YET') }}</div>
            }
          </div>
        </div>
        <div class="mt-4 text-xs text-gray-400">{{ settings.t('CHANGE_RECORDS_INFO') }}</div>
      </div>
    </div>
  }
  <!-- High Scores modal End -->

  @if (!isProduction) {
    <div
      class="fixed bottom-10 left-4 z-[9999] flex flex-col gap-2 bg-black/80 p-2 rounded border border-red-500 shadow-lg backdrop-blur-sm"
    >
      <div class="text-red-500 font-bold text-xs uppercase text-center mb-1 border-b border-red-900/50 pb-1">
        Debug Mode
      </div>
      <button
        (click)="gameEngine.debugInstantWin()"
        class="bg-red-900/40 hover:bg-red-800/60 text-red-100 text-xs px-3 py-1.5 rounded border border-red-800 transition-colors cursor-pointer"
      >
        ‚ö° Instant Win
      </button>
      <button
        (click)="gameEngine.debugCycleSettings()"
        class="bg-blue-900/40 hover:bg-blue-800/60 text-blue-100 text-xs px-3 py-1.5 rounded border border-blue-800 transition-colors cursor-pointer"
      >
        üîÑ Cycle Settings
      </button>
      <div class="text-[10px] text-gray-400 text-center font-mono mt-1">
        {{ settings.difficultyLabel() }} | {{ settings.mapSizeLabel() }}
      </div>
    </div>
  }
</div>
